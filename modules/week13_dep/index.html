<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 13: Production Deployment | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.9d277d19.css" as="style"><link rel="preload" href="/w2023/assets/js/app.a268f35f.js" as="script"><link rel="preload" href="/w2023/assets/js/3.30d56026.js" as="script"><link rel="preload" href="/w2023/assets/js/2.c49fd8f9.js" as="script"><link rel="preload" href="/w2023/assets/js/16.1e8637e4.js" as="script"><link rel="preload" href="/w2023/assets/js/17.feedfd9c.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.b7c1a16d.js"><link rel="prefetch" href="/w2023/assets/js/11.f2aecf7a.js"><link rel="prefetch" href="/w2023/assets/js/12.7642e84c.js"><link rel="prefetch" href="/w2023/assets/js/13.5e27a08c.js"><link rel="prefetch" href="/w2023/assets/js/14.4b92b91c.js"><link rel="prefetch" href="/w2023/assets/js/15.628eb87b.js"><link rel="prefetch" href="/w2023/assets/js/18.4d23c18f.js"><link rel="prefetch" href="/w2023/assets/js/19.bdc3f6f0.js"><link rel="prefetch" href="/w2023/assets/js/20.7bb0ba89.js"><link rel="prefetch" href="/w2023/assets/js/21.bbf158ab.js"><link rel="prefetch" href="/w2023/assets/js/22.04ba04d6.js"><link rel="prefetch" href="/w2023/assets/js/23.b3f8222f.js"><link rel="prefetch" href="/w2023/assets/js/24.74d3f93b.js"><link rel="prefetch" href="/w2023/assets/js/25.5343cc2e.js"><link rel="prefetch" href="/w2023/assets/js/26.9f73a8bf.js"><link rel="prefetch" href="/w2023/assets/js/27.45bceba5.js"><link rel="prefetch" href="/w2023/assets/js/28.3f49100e.js"><link rel="prefetch" href="/w2023/assets/js/29.dff6b604.js"><link rel="prefetch" href="/w2023/assets/js/30.0d01a8e4.js"><link rel="prefetch" href="/w2023/assets/js/31.cfbc8e9f.js"><link rel="prefetch" href="/w2023/assets/js/32.2bd8381f.js"><link rel="prefetch" href="/w2023/assets/js/33.c0fa7e80.js"><link rel="prefetch" href="/w2023/assets/js/34.a29cefed.js"><link rel="prefetch" href="/w2023/assets/js/35.26354f67.js"><link rel="prefetch" href="/w2023/assets/js/36.5d697666.js"><link rel="prefetch" href="/w2023/assets/js/37.19db9f95.js"><link rel="prefetch" href="/w2023/assets/js/38.388e9638.js"><link rel="prefetch" href="/w2023/assets/js/39.aa1380a5.js"><link rel="prefetch" href="/w2023/assets/js/4.c0130289.js"><link rel="prefetch" href="/w2023/assets/js/40.1e348976.js"><link rel="prefetch" href="/w2023/assets/js/5.9d721531.js"><link rel="prefetch" href="/w2023/assets/js/6.fec5c1cc.js"><link rel="prefetch" href="/w2023/assets/js/7.054fdd44.js"><link rel="prefetch" href="/w2023/assets/js/8.5b458cb5.js"><link rel="prefetch" href="/w2023/assets/js/9.2198ac92.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.9d277d19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Introduction</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/overview/" class="sidebar-link">Overview</a></li><li><a href="/w2023/overview/contacts.html" class="sidebar-link">Contacts</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Content Modules</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 13</span><br> <span class="title">Production Deployment</span></h1> <div class="custom-block danger"><p class="custom-block-title">Quiz 9: Production Prep <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>15 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <div class="custom-block warning"><p class="custom-block-title">Assignment Reminder</p> <p><a href="/w2023/deliverables/final.html">Final project - GIFTR</a> is due by <strong>5:00 pm April 17, 2020</strong>.<br>
This is the final deadline. There will be no extensions.</p> <p>Counts for 30% of your MAD9124 final grade.</p></div> <h2 id="architecture"><a href="#architecture" class="header-anchor">#</a> Architecture</h2> <p>Of all cloud infrastructure service providers, Amazon Web Services (AWS) is far and away the market leader. We will take advantage of their generous education credits to learn how to deploy the final project using a typical architectural pattern.</p> <p>Our main web service API application will be bundled into a Docker container which can be auto-scaled with service demand. This service container cluster will be accessed via an HTTP/HTTPS load-balancer, which can also manage the secure HTTPS connection with the client application. The Express containers will talk to the MongoDB service running in a high-availability cluster.</p> <p>Additionally, your client application from MAD9022 could be served from a global content delivery network.</p> <p>The key service components that we will need include:</p> <p><strong>Backend Web Service</strong></p> <ul><li>Docker Hub (image repository)</li> <li>Amazon Virtual Private Cloud (VPC)</li> <li><strike>AWS Certificate Manager</strike></li> <li>Amazon HTTP/HTTP Application Load Balancer (ELB)</li> <li>Amazon Elastic Container Service (ECS) with Fargate</li> <li>MongoDB Atlas (deployed to a managed Amazon EC2 Cluster)</li></ul> <p><strong>Frontend Client APP</strong></p> <ul><li><strike>Amazon Simple Storage Service (S3)</strike></li> <li><strike>Amazon CloudFront (CDN)</strike></li> <li>GitHub PWA Private Repo</li></ul> <h2 id="setup-hosted-mongodb"><a href="#setup-hosted-mongodb" class="header-anchor">#</a> Setup Hosted MongoDB</h2> <p>We will use the free tier of the <a href="https://www.mongodb.com/cloud/atlas" target="_blank" rel="noopener noreferrer">MongoDB Atlas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> service to deploy a managed MongoDB instance to the same AWS region as our production Express server containers.</p> <h3 id="create-a-mongodb-cloud-account"><a href="#create-a-mongodb-cloud-account" class="header-anchor">#</a> Create a MongoDB cloud account</h3> <p>From the <a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">MongoDB home page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, click the green <code>Start Free</code> button.
<img src="/w2023/assets/img/mongo-homepage.ab3e76a9.png" alt="MongoDB home page"></p> <p>Fill in the form to create your free account. <strong>Please use your Algonquin College email address</strong>.
<img src="/w2023/assets/img/mongo-atlas-create-account.30dfcda3.png" alt="Atlas sign-up form"></p> <p>You should shortly receive a confirmation email from MongoDB Atlas. Click the <code>Sign In</code> button in that email.
<img src="/w2023/assets/img/mongo-atlas-confirmation-email.75dd2831.png" alt="Confirmation email"></p> <p>That will take you to the <a href="https://account.mongodb.com/account/login" target="_blank" rel="noopener noreferrer">MongoDB Atlas login page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
<img src="/w2023/assets/img/mongo-atlas-login.e8772dae.png" alt="MongoDB Atlas Login"></p> <h3 id="create-database-cluster"><a href="#create-database-cluster" class="header-anchor">#</a> Create Database Cluster</h3> <p>Follow the prompts to create your first Project and Cluster.</p> <p><img src="/w2023/assets/img/mongo-create-cluster.70967fa3.png" alt="create cluster"></p> <p>Choose the <strong>Shared Clusters</strong> option -- the free one.
<img src="/w2023/assets/img/mongo-shared-clusters.7eddf090.png" alt="shared clusters"></p> <h4 id="configure-cluster"><a href="#configure-cluster" class="header-anchor">#</a> Configure Cluster</h4> <p>Choose <strong>AWS</strong> as the cloud provider. <strong>DO NOT</strong> choose 'Multi-Region ...'</p> <p>Choose the <strong>N. Virginia</strong> AWS Region.
<img src="/w2023/assets/img/mongo-cluster-provider.7c414a5b.png" alt="cluster configuration - AWS region"></p> <p>Under the heading <strong>Cluster Tier</strong>, choose <code>M0 Sandbox</code> -- this is the free one.
<img src="/w2023/assets/img/mongo-cluster-size.6d814b8e.png" alt="cluster configuration - size"></p> <p>Do not select any <strong>Additional Settings</strong>. They are not available in the free tier.</p> <p>Set the <strong>Cluster Name</strong> to <code>GIFTR</code>.
<img src="/w2023/assets/img/mongo-cluster-name.ead36e99.png" alt="cluster configuration - name"></p> <p>Verify your settings and click the green <code>Create Cluster</code> button.</p> <p>You should now see the <strong>Clusters Dashboard</strong> while your new cluster is being provisioned. There should be a blue <code>sandbox</code> label on your cluster -- this means the free tier.
<img src="/w2023/assets/img/mongo-cluster-dashboard.48fa593c.png" alt="cluster configuration - name"></p> <h4 id="setup-connection-security"><a href="#setup-connection-security" class="header-anchor">#</a> Setup Connection Security</h4> <p>There are still a few more steps. Click the <code>connect</code> button under your cluster name to bring up an information modal.</p> <p>We will be accessing this cluster from multiple locations – home, school, AWS. We could (and in a real app SHOULD) whitelist only those IP addresses that need to connect to the database. But, for this project we can simply allow all.
<img src="/w2023/assets/img/mongo-whitelist-ips.4e635c11.png" alt="cluster configuration - IP addresses"></p> <p>Click the <code>Add a Different IP Address</code> button, and then enter <code>0.0.0.0/0</code> for the IP address (CDIR notation) and click <code>Add IP Address</code>.</p> <p>Next you will be asked to create an new administrative user for your database cluster. I called mine <code>madadmin</code> and selected the <code>autogenerate password</code> option for a reasonably secure random password.</p> <p><img src="/w2023/assets/img/mongo-create-user.08dd85da.png" alt="create database user"></p> <div class="custom-block warning"><p class="custom-block-title">Copy the password</p> <p>Don't forget to click the <code>show</code> button next to the password, and then copy it to your config JSON file. You will never see this password again.</p></div> <p>We need to get the connection string details for this new database cluster. Click the <code>Choose connection method</code> button at the bottom of the modal.
<img src="/w2023/assets/img/mongo-choose-connection-method.d6cf4669.png" alt="create database user"></p> <p>We want the middle option <strong>Connect your application</strong>.
<img src="/w2023/assets/img/mongo-connect-options.ac4d4be9.png" alt="cluster connection options"></p> <p>Copy the <strong>hostname</strong> portion of the connection string. We will need that in our config JSON file.
<img src="/w2023/assets/img/mongo-connect-string.a0fac0d2.png" alt="cluster connection string"></p> <p>Copy the <strong>authentication database name</strong> portion of the connection string. We will need that in our config JSON file too.
<img src="/w2023/assets/img/mongo-connect-string2.93e1fbd7.png" alt="cluster connection string"></p> <h3 id="connect-mongoose-to-the-atlas-cluster"><a href="#connect-mongoose-to-the-atlas-cluster" class="header-anchor">#</a> Connect Mongoose to the Atlas Cluster</h3> <p>Up until now, the connection string to tell Mongoose how to open a connection to the database took this format:</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb://hostname:port/database-name
</code></pre></div><p>e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb://localhost:27017/mad9124
</code></pre></div><h4 id="hosted-atlas-cluster"><a href="#hosted-atlas-cluster" class="header-anchor">#</a> Hosted Atlas Cluster</h4> <p>The full connection string for MongoDB databases hosted on an Atlas cluster look a little different. Here is what mine looks like:</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb+srv://&lt;username&gt;:&lt;password&gt;@giftr-1p8fa.mongodb.net/test?retryWrites=true&amp;w=majority
</code></pre></div><p><em>(Don't use this one. Go get your own.)</em></p> <h5 id="from-the-above-examples"><a href="#from-the-above-examples" class="header-anchor">#</a> From the above examples</h5> <p>The scheme changes to <code>mongodb+srv://</code></p> <p>Database user credentials are inserted: <code>&lt;username&gt;:&lt;password&gt;@</code></p> <p>The hostname becomes <code>_something_.mongodb.net</code></p> <p>The default database <code>/test</code> is used to authenticate the db user.</p> <p>There are some other options set at the end: <code>?retryWrites=true&amp;w=majority</code></p> <h3 id="update-the-connectdatabase-js-module"><a href="#update-the-connectdatabase-js-module" class="header-anchor">#</a> Update the <code>connectDatabase.js</code> Module</h3> <p>It is a very common practice to set up a final integration testing or staging environment that very closely mirrors the production environment. That is what we are going to do for the final project. This will allow us to simplify some of the deployment details.</p> <p>Remember we are retrieving the configuration variables using the <code>config.get()</code> method. We will set the <code>NODE_ENV</code> environment variable to<code>stage</code>, so you will need to create a new <code>/config/stage.json</code> file with your connection credentials. e.g.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;db&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;scheme&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mongodb+srv&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;madadmin&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yourGuessIsAsGoodAsMine&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;giftr-1p8fa.mongodb.net&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;authSource&quot;</span><span class="token operator">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;w20-final-giftr&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>In a final production deployment, you would not store the database username and password in this config file. They should be injected into the runtime container using environment variables.</p> <p>But, this will let us better help you with troubleshooting and help us with grading your assignment.</p></div> <p>Then in the <code>/startup/connectDatabase.js</code> module, we need to conditionally construct the connection string based on the target scheme: <code>mongodb</code> v.s. <code>mongodb+srv</code>.</p> <p>The updated file should look something like this ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./logger'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>scheme<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> name<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authSource<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> credentials <span class="token operator">=</span> username <span class="token operator">&amp;&amp;</span> password <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>

  <span class="token keyword">let</span> connectionString <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>scheme<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>credentials<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>scheme <span class="token operator">===</span> <span class="token string">'mongodb'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    connectionString <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?authSource=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>authSource<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    connectionString <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>authSource<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?retryWrites=true&amp;w=majority</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  mongoose
    <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>
      connectionString<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">useNewUrlParser</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">useUnifiedTopology</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">useCreateIndex</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">useFindAndModify</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">dbName</span><span class="token operator">:</span> name
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Connected to MongoDB @ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error connecting to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>OK. LET'S TEST IT!</strong></p> <p>Update the <code>scripts</code> key of the <code>package.json</code> file to add a <code>stage</code> script that is the same as the <code>dev</code> script except that we will set <code>NODE_ENV=stage</code>.</p> <div class="language-json extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;API_JWTKEY=supersecretkey nodemon server.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;stage&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=stage API_JWTKEY=supersecretkey nodemon server.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node server.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>Now run <code>npm run stage</code> in the terminal and use Postman to make sure that everything is working.</p> <p>You can still visually check the contents of the database with MongoDB Compass. Just use full the connection string from the Atlas dashboard.</p> <p><img src="/w2023/assets/img/mongo-connect-options.ac4d4be9.png" alt="cluster connection options"></p> <p>Don't forget to replace <code>&lt;password&gt;</code> with your real password. e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>mongodb+srv://madadmin:yourGuessIsAsGoodAsMine@giftr-1p8fa.mongodb.net/test
</code></pre></div><h2 id="health-check-route"><a href="#health-check-route" class="header-anchor">#</a> Health Check Route</h2> <p>Most production deployments will have some kind of automated periodic monitoring to see if your deployed service is still up and running. We will facilitate this by creating a simple HTTP route handler in the main <code>app.js</code> module. It could be anything that we choose. The AWS HTTP Load Balancer will default to the root path for our service, so let's just use that for now.</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">healthStatus</span><span class="token operator">:</span> <span class="token string">'UP'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>The AWS container management service will regularly poll this route looking for a <code>200</code> response code. You will be able to see the health status in the AWS CloudWatch console.</p> <h2 id="publish-a-docker-image"><a href="#publish-a-docker-image" class="header-anchor">#</a> Publish a Docker Image</h2> <p>In most development teams these days, everyone needs to know a little about DevOps. You could do a whole course on Docker, containers, and Kubernetes, but for now we are going to simulate a scenario that you are very like to encounter. As a junior developer, a more senior developer on the team has already worked out the correct procedure to bundle and deploy your application, and they will give you some key files and instructions.</p> <p>Starting in module 5, you have been using Docker as an easy way to run MongoDB in your local development environment. We used a pre-made Docker Image definition (mongo:bionic) that we pulled from the Docker Hub repository.</p> <p>You can create and publish our own Docker Image to bundle your Express web service application. This image can then be use to deploy one or more copies of your application on a cloud hosting service like AWS, Azure, or Google Cloud.</p> <div class="custom-block tip"><p class="custom-block-title">If you haven't already ...</p> <p>Create a free <a href="https://hub.docker.com" target="_blank" rel="noopener noreferrer">Docker Hub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> account.<br>
Download <strong>Docker Desktop</strong> and run the installer.</p></div> <h3 id="create-a-dockerfile"><a href="#create-a-dockerfile" class="header-anchor">#</a> Create a Dockerfile</h3> <p>The <code>Dockerfile</code> is the recipe for creating a Docker Image. It should be placed in the top level of your project folders. Note the capitalization and there is no extension - just <code>Dockerfile</code>.</p> <p>This will use the <a href="https://hub.docker.com/_/node" target="_blank" rel="noopener noreferrer">official node version 12 image<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> from Docker Hub as the starting point. It then creates the directory structure that our project requires and copies your code from the local project folder into the container image.</p> <p><strong>Make sure that your project folder structure matches the Dockerfile.</strong></p> <div class="language-docker extra-class"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> node:12-slim</span>

<span class="token instruction"><span class="token keyword">ENV</span> API_PORT=<span class="token string">&quot;80&quot;</span></span>
<span class="token instruction"><span class="token keyword">ENV</span> DEBUG=<span class="token string">&quot;api:*&quot;</span></span>

<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /app /app/config /app/exceptions /app/logs /app/middleware /app/models /app/public /app/routes /app/startup</span>

<span class="token instruction"><span class="token keyword">COPY</span> config/ /app/config/</span>
<span class="token instruction"><span class="token keyword">COPY</span> exceptions/ /app/exceptions/</span>
<span class="token instruction"><span class="token keyword">COPY</span> middleware/ /app/middleware/</span>
<span class="token instruction"><span class="token keyword">COPY</span> models/ /app/models/</span>
<span class="token instruction"><span class="token keyword">COPY</span> public/ /app/public/</span>
<span class="token instruction"><span class="token keyword">COPY</span> routes/ /app/routes/</span>
<span class="token instruction"><span class="token keyword">COPY</span> startup/ /app/startup/</span>
<span class="token instruction"><span class="token keyword">COPY</span> server.js app.js package.json /app/</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install --unsafe-perm</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span>
<span class="token instruction"><span class="token keyword">CMD</span> node server.js</span>
</code></pre></div><h3 id="split-server-js-and-app-js"><a href="#split-server-js-and-app-js" class="header-anchor">#</a> Split server.js and app.js</h3> <p>That final line in the Dockerfile, <code>CMD node server.js</code>. That is the command that will be invoked when the deployed container is started. If you have all of your Express application defined in <code>app.js</code>, then you could change the last line of the Dockerfile to be <code>CMD node app.js</code>.</p> <p>Or, you might want to create both a <code>server.js</code> file and an <code>app.js</code> file. This is a quite common practice as it separates the code for defining middleware and route handlers in the <code>app.js</code> file which is then imported into the <code>server.js</code> module which then only holds the instructions spinning up the Node.js HTTP server, passing in the <code>app.js</code> module as a configuration object to the server (see lines 5 and 11 in the code example below).</p> <p>Here is an example <code>server.js</code> file serving only HTTP.<br> <strong>This is what you should use for your final project.</strong></p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./startup/logger'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Create HTTP server.
 * HTTP server listen on provided port, on all network interfaces.
 */</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> onListening<span class="token punctuation">)</span>

<span class="token comment">/**
 * Common listener callback functions
 */</span>
<span class="token keyword">function</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Express failed to listen on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">onListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Express is listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>If you are going to be running your Node.js server with HTTPS, you <strong>must</strong> set it up this way.</p></div> <p>Here is how it would look if we set it up to use HTTPS with a &quot;let's encrypt&quot; certificate.<br> <strong>This is for your future reference only. DO NOT use this for your final project.</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./startup/logger'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./app'</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Create HTTP server.
 * HTTP server listen on provided port, on all network interfaces.
 */</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> onListening<span class="token punctuation">)</span>

<span class="token comment">/**
 * Create HTTPS server.
 * HTTPS server listen on standard port, on all network interfaces.
 */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/etc/letsencrypt/live/mad9124.rocks/privkey.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cert</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/etc/letsencrypt/live/mad9124.rocks/fullchain.pem'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">ca</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/etc/letsencrypt/live/mad9124.rocks/chain.pem'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> serverSSL <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> app<span class="token punctuation">)</span>
  <span class="token keyword">const</span> TLSPort <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_TLSPORT</span> <span class="token operator">||</span> <span class="token number">443</span>
  serverSSL<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>TLSPort<span class="token punctuation">)</span>
  serverSSL<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span>
  serverSSL<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> onListening<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Common listener callback functions
 */</span>
<span class="token keyword">function</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Express failed to listen on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">onListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Express is listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="simplified-app-js"><a href="#simplified-app-js" class="header-anchor">#</a> Simplified app.js</h4> <p>Now that the <code>app.js</code> module doesn't need any code for creating the HTTP server, it can be simplified to something like this ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./startup/connectDatabase'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Apply global middleware with app.use()</span>

<span class="token comment">// Add the health check route</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">healthStatus</span><span class="token operator">:</span> <span class="token string">'UP'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Link the auth and api route handler modules</span>

<span class="token comment">// Apply the global error handler middleware</span>

<span class="token comment">// Export the `app` object</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app
</code></pre></div><h3 id="build-a-local-docker-image"><a href="#build-a-local-docker-image" class="header-anchor">#</a> Build a local Docker image</h3> <p>We have created the Dockerfile and refactored our code. It is time to build the container image with the <a href="https://docs.docker.com/engine/reference/commandline/build/" target="_blank" rel="noopener noreferrer">docker build<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> command. Use the <code>--tag=</code> command option to set the name of the local Docker Image file that will be created. The <code>:latest</code> suffix is the version label.</p> <div class="language- extra-class"><pre class="language-text"><code>docker build --tag=giftr-api-w20:latest .
</code></pre></div><p>This will create an Ubuntu Linux container with Node v12 pre configured and then copy in your project files as defined in the <code>Dockerfile</code>. Then it will run <code>npm install</code> in your project root folder (in the container) to ensure that all required dependencies are correctly installed.</p> <p>When this process is complete you will have a new Docker Image that you can use to create a complete isolated runtime of your Express web service application. You can run it locally to test it.</p> <p>Here is an updated <code>docker-compose.yml</code> file that will spin up your new container on your local machine for testing. First, make sure that you stop any other Express server that you might have running.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mongo</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo<span class="token punctuation">:</span>bionic
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mongo
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MONGO_INITDB_ROOT_USERNAME</span><span class="token punctuation">:</span> madadmin
      <span class="token key atrule">MONGO_INITDB_ROOT_PASSWORD</span><span class="token punctuation">:</span> supersecretpassword
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span><span class="token number">27017</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./data/mongo<span class="token punctuation">:</span>/data/db

  <span class="token key atrule">express</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> giftr<span class="token punctuation">-</span>api<span class="token punctuation">-</span>w20
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> giftr<span class="token punctuation">-</span>api<span class="token punctuation">-</span>w20
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mongo
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">API_JWTKEY</span><span class="token punctuation">:</span> keur0uhwg802fkzh6e72lw0m69g3xv
      <span class="token key atrule">API_PORT</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">NODE_ENV</span><span class="token punctuation">:</span> <span class="token string">'stage'</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3030<span class="token punctuation">:</span><span class="token number">80</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> node server.js
</code></pre></div><p>Now run <code>docker-compose up -d</code>. If everything is configured correctly, your new API server container will spin up and try to authenticate with the MongoDB Atlas server that you setup earlier.</p> <p>Try sending some test requests from Postman to <code>localhost:3030</code>. Then check the MongoDB Atlas database with MongoDB Compass to visually verify the requests went to the correct database.</p> <p>If everything looks good we can publish the Docker Image on Docker Hub.</p> <h3 id="tag-the-image"><a href="#tag-the-image" class="header-anchor">#</a> Tag the image</h3> <p>Before you can push the image up to Docker Hub, you need to <code>tag</code> the local image with your Docker Hub username prefix. Replace <code>&lt;username&gt;</code> with your Docker Hub username.</p> <div class="language- extra-class"><pre class="language-text"><code>docker tag giftr-api-w20 &lt;username&gt;/giftr-api-w20
</code></pre></div><h3 id="push-the-image-to-docker-hub"><a href="#push-the-image-to-docker-hub" class="header-anchor">#</a> Push the image to Docker Hub</h3> <p>Make sure that you are logged into Docker Hub. This command will prompt you for your Docker Hub username and password.</p> <div class="language- extra-class"><pre class="language-text"><code>docker login docker.io
</code></pre></div><p>Now you can push it. Replace <code>&lt;username&gt;</code> with your Docker Hub username.</p> <div class="language- extra-class"><pre class="language-text"><code>docker push &lt;username&gt;/giftr-api-w20
</code></pre></div><p><strong>Congratulations!</strong></p> <p>You have successfully published your first Docker Image.</p> <h2 id="deploying-to-aws"><a href="#deploying-to-aws" class="header-anchor">#</a> Deploying to AWS</h2> <p>Now it is time to setup the hosting environment on AWS for your Docker container to run.</p> <h3 id="aws-classroom-account"><a href="#aws-classroom-account" class="header-anchor">#</a> AWS Classroom Account</h3> <p>By now you should have received an email invitation to join our AWS Classroom and sign-up for a free AWS Educate - Student Account. There are <a href="https://aws.amazon.com/education/awseducate/students/" target="_blank" rel="noopener noreferrer">many benefits<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> attached to the free student account which you can use to continue your learning over the summer.</p> <p>Once you have accepted the invitation and logged into the AWS Educate portal, find the link to &quot;My Classrooms&quot;. You should see one listed for &quot;Mobile API Development&quot;. Click the blue &quot;Go to classroom&quot; button on the right.
<img src="/w2023/assets/img/aws-classroom.b70bbfb5.png" alt="AWS classrooms list"></p> <p>You will now be prompted to agree to the <em>terms and conditions</em> for using the service.
<img src="/w2023/assets/img/aws-classroom-setup12.b0856cfe.png" alt="Vocareum dashboard"></p> <p>Your browser should be redirected to the <strong>Vocareum Dashboard</strong>. Click on the card for Mobile API Development. This will open a summary page for your AWS Educate Classroom Account. It has some helpful FAQs and you can see your remaining credit balance for AWS services. You have been given a $50 for this classroom, which is more than enough to cover what we will do, and give you some credits to play with over the summer.
<img src="/w2023/assets/img/aws-classroom-setup15.5f332920.png" alt="AWS account summary"></p> <p>Click on the <strong>AWS Console</strong> button and you will be automatically logged into the AWS Console with your AWS Educate Classroom account.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>This may trigger the &quot;pop-up blocker&quot; in your browser. You will need to grant permission for this site. Look for the warning notice in the URL bar.</p></div> <p>Now you know how to get logged in. We can start doing real work!
<img src="/w2023/assets/img/aws-classroom-setup16.df90114d.png" alt="AWS console"></p> <h3 id="configure-the-elastic-container-service"><a href="#configure-the-elastic-container-service" class="header-anchor">#</a> Configure the Elastic Container Service</h3> <h4 id="_1-go-to-the-ecs-console"><a href="#_1-go-to-the-ecs-console" class="header-anchor">#</a> 1. Go to the ECS console</h4> <p>Type <code>ECS</code> into the <strong>Find Services</strong> search box on the AWS Console and then select the <strong>Elastic Container Service</strong> <img src="/w2023/assets/img/aws-search-ecs.20ef23ea.png" alt="AWS console - search"></p> <h4 id="_2-start-the-setup-wizard"><a href="#_2-start-the-setup-wizard" class="header-anchor">#</a> 2. Start the Setup Wizard</h4> <p>On the next screen you should see a <strong>Get Started</strong> button. Click that to start the &quot;First Run Wizard&quot;. This is a more automated path to provision your container service cluster.
<img src="/w2023/assets/img/aws-ecs-get-started.fa2e3e9e.png" alt="ECS console - get started"></p> <h4 id="_3-define-aws-ecs-container-task-service"><a href="#_3-define-aws-ecs-container-task-service" class="header-anchor">#</a> 3. Define AWS ECS Container/Task/Service</h4> <p>Now define the runtime parameters for your container service. There are several related parts and they fit together like Russian nesting dolls.</p> <ul><li>A container definition links to a Docker image.</li> <li>A task sets the resources for a container definition.</li> <li>A service may include one or more related tasks.</li> <li>A cluster may host one or more services.</li></ul> <p><img src="/w2023/assets/img/aws-ecs-hierarchy.91fe84ad.png" alt="ECS hierarchy diagram"></p> <p>Start with the inner most box and work out.</p> <h5 id="container-definition"><a href="#container-definition" class="header-anchor">#</a> Container Definition</h5> <p>Choose the <strong>custom</strong> configuration card and click the <strong>configure</strong> button.
<img src="/w2023/assets/img/aws-ecs-wizard-1.79b41a40.png" alt="ECS wizard step 1"></p> <p>Set these settings in the <strong>Standard</strong> section of the configuration form:</p> <ul><li>Container name: <code>giftr-api-container</code></li> <li>Image: <code>&lt;Docker-Hub-username&gt;/giftr-api-w20</code></li> <li>Soft limit: <code>500</code></li> <li>Port mapping: <code>80</code></li></ul> <p><img src="/w2023/assets/img/aws-ecs-wizard-2.a4ff4b2b.png" alt="ECS wizard step 2"></p> <p>Expand the <strong>Advanced container configuration</strong> section of the form and scroll down to the <strong>Environment Variables</strong> heading. Add the following key:value pairs:</p> <ul><li>NODE_ENV = <code>stage</code></li> <li>API_PORT = <code>80</code></li> <li>API_JWTKEY = <code>&lt;your-secret-random-key&gt;</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Use the <code>genKey.js</code> script from week 11 to generate a new random key.</p></div> <p><img src="/w2023/assets/img/aws-ecs-wizard-3.888078f3.png" alt="ECS wizard step 3"></p> <p>Then scroll all the way to the bottom and check the <strong>Auto-configure CloudWatch Logs</strong> option next to <strong>Log Configuration</strong>. Then click the blue <strong>Update</strong> button in the bottom right corner.
<img src="/w2023/assets/img/aws-ecs-wizard-4.cb2abec9.png" alt="ECS wizard step 4"></p> <h5 id="task-definition"><a href="#task-definition" class="header-anchor">#</a> Task Definition</h5> <p>The slide over dialog will close and you will be back to the main ECS Configuration Wizard. Scroll down and click the <strong>Edit</strong> button on the <strong>Task Definition</strong> line. Change the task definition name to <code>giftr-api-task</code> and click the <strong>Save</strong> button.
<img src="/w2023/assets/img/aws-ecs-wizard-5.3608d763.png" alt="ECS wizard step 5"></p> <p>Now click the <strong>Next</strong> button in the bottom right corner.
<img src="/w2023/assets/img/aws-ecs-wizard-6.cbffc288.png" alt="ECS wizard step 6"></p> <h5 id="service-definition"><a href="#service-definition" class="header-anchor">#</a> Service Definition</h5> <p>The service defaults to no load balancer. Change the selection in the middle of the page to <strong>Application Load Balancer</strong>. This will set it for port 80 HTTP.
<img src="/w2023/assets/img/aws-ecs-wizard-7.3432c22e.png" alt="ECS wizard step 7"></p> <p>Next click the <strong>Edit</strong> button on the <strong>Define your service</strong> line. Set the <strong>number of desired tasks</strong> to be <code>2</code> and then click the blue <strong>Save</strong> button.
<img src="/w2023/assets/img/aws-ecs-wizard-8.43a4ceb7.png" alt="ECS wizard step 8"></p> <p>The main ECS configuration wizard screen should now look like this screenshot. Click the blue <strong>Next</strong> button.
<img src="/w2023/assets/img/aws-ecs-wizard-9.0c908c6a.png" alt="ECS wizard step 9"></p> <h5 id="cluster-definition"><a href="#cluster-definition" class="header-anchor">#</a> Cluster Definition</h5> <p>Set the cluster name to <code>mad9124</code>, and click the blue <strong>Next</strong> button.
<img src="/w2023/assets/img/aws-ecs-wizard-10.f45b13e1.png" alt="ECS wizard step 10"></p> <p>Take one last look at all of the settings on the <strong>Review</strong> page.
<img src="/w2023/assets/img/aws-ecs-wizard-11.4062f7f9.png" alt="ECS wizard step 11"></p> <p>Then click the blue <strong>Create</strong> button, and watch the progress spinners for 5 to 10 minutes.
<img src="/w2023/assets/img/aws-ecs-wizard-12.453f5272.png" alt="ECS wizard step 12"></p> <p><strong>WOOO HOOOO! You have launched your first AWS CloudFormation Stack!</strong></p> <p>When all 10 provisioning steps have a green check mark, you can click the <strong>View Service</strong> button to go back to the ECS Dashboard. This will take to detail view for your newly provisioned service. It should look something like this ...
<img src="/w2023/assets/img/aws-ecs-service-details.eb153dc7.png" alt="ECS service details"></p> <h4 id="_4-test-with-load-balancer-address-with-postman"><a href="#_4-test-with-load-balancer-address-with-postman" class="header-anchor">#</a> 4. Test with Load Balancer address with Postman</h4> <p>So, now we should run some Postman test. But what is the URL?</p> <p>In the ECS service definition, we created an application load balancer. This will be the &quot;front door&quot; URL for your API service cluster.</p> <p>To find the load balancer's public DNS name, we need to go to the EC2 Console section of AWS.</p> <p>Click on the <strong>Services</strong> top menu drop-down and then select <strong>EC2</strong> from the top of the <em>Compute</em> service list.
<img src="/w2023/assets/img/aws-navigate-ec2.8fac0c20.png" alt="Navigate to EC2"></p> <p>This will take you to the main EC2 Dashboard. Select <strong>Load Balancers</strong> from the Resource options in the middle of the page.
<img src="/w2023/assets/img/aws-ec2-dashboard.7d29c3d2.png" alt="EC2 dashboard"></p> <p>You will now see the list of active load balancers on your AWS Classroom account. There should only be one at this point. Click the check box next to the name of your load balancer to see the details at the bottom of the screen.
<img src="/w2023/assets/img/aws-load-balancer-details.a2d5cc62.png" alt="EC2 load balancer details"></p> <p>Copy the <strong>DNS name</strong> and use that as the hostname for your Postman tests.</p> <h4 id="_5-link-to-load-balancer-in-client-app"><a href="#_5-link-to-load-balancer-in-client-app" class="header-anchor">#</a> 5. Link to Load Balancer in client app.</h4> <p>In a real app, you could now use this URL in the <code>fetch</code> code of your frontend client application.</p> <p>You would also want to turn on HTTPS for the load balancer, or your browser will block access to &quot;mixed content requests&quot;. At the moment, the AWS Classroom accounts don't have access to the AWS Certificate Manager Service, so we cannot do this right now.</p> <h3 id="congratulations"><a href="#congratulations" class="header-anchor">#</a> Congratulations!</h3> <p>You have successfully deployed a load balanced redundant API web service container cluster connected to a separate redundant database cluster — all hosted on Amazon Web Services.</p> <h2 id="for-additional-resources"><a href="#for-additional-resources" class="header-anchor">#</a> For additional resources</h2> <p>The procedure above is an excellent introduction to containers and AWS. This can be a great talking point in a job interview, but there is more to learn. Please review these additional online resources.</p> <ul><li><p><a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener noreferrer">Amazon Elastic Container Service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://aws.amazon.com/fargate" target="_blank" rel="noopener noreferrer">AWS Fargate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://aws.amazon.com/vpc/" target="_blank" rel="noopener noreferrer">Amazon Virtual Private Cloud<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://aws.amazon.com/elasticloadbalancing" target="_blank" rel="noopener noreferrer">Amazon Elastic Load Balancing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://docs.docker.com/engine/docker-overview/" target="_blank" rel="noopener noreferrer">Docker overview<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.youtube.com/watch?v=YFl2mCHdv24" target="_blank" rel="noopener noreferrer">Learn Docker in 12 Minutes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.youtube.com/watch?v=Qw9zlE3t8Ko" target="_blank" rel="noopener noreferrer">Docker Compose in 12 Minutes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/3/2023, 12:04:36 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/w2023/assets/js/app.a268f35f.js" defer></script><script src="/w2023/assets/js/3.30d56026.js" defer></script><script src="/w2023/assets/js/2.c49fd8f9.js" defer></script><script src="/w2023/assets/js/16.1e8637e4.js" defer></script><script src="/w2023/assets/js/17.feedfd9c.js" defer></script>
  </body>
</html>
