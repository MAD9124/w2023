<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 14: Preparing for Production | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.9d277d19.css" as="style"><link rel="preload" href="/w2023/assets/js/app.a268f35f.js" as="script"><link rel="preload" href="/w2023/assets/js/3.30d56026.js" as="script"><link rel="preload" href="/w2023/assets/js/7.054fdd44.js" as="script"><link rel="preload" href="/w2023/assets/js/16.1e8637e4.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.b7c1a16d.js"><link rel="prefetch" href="/w2023/assets/js/11.f2aecf7a.js"><link rel="prefetch" href="/w2023/assets/js/12.7642e84c.js"><link rel="prefetch" href="/w2023/assets/js/13.5e27a08c.js"><link rel="prefetch" href="/w2023/assets/js/14.4b92b91c.js"><link rel="prefetch" href="/w2023/assets/js/15.628eb87b.js"><link rel="prefetch" href="/w2023/assets/js/17.feedfd9c.js"><link rel="prefetch" href="/w2023/assets/js/18.4d23c18f.js"><link rel="prefetch" href="/w2023/assets/js/19.bdc3f6f0.js"><link rel="prefetch" href="/w2023/assets/js/2.c49fd8f9.js"><link rel="prefetch" href="/w2023/assets/js/20.7bb0ba89.js"><link rel="prefetch" href="/w2023/assets/js/21.bbf158ab.js"><link rel="prefetch" href="/w2023/assets/js/22.04ba04d6.js"><link rel="prefetch" href="/w2023/assets/js/23.b3f8222f.js"><link rel="prefetch" href="/w2023/assets/js/24.74d3f93b.js"><link rel="prefetch" href="/w2023/assets/js/25.5343cc2e.js"><link rel="prefetch" href="/w2023/assets/js/26.9f73a8bf.js"><link rel="prefetch" href="/w2023/assets/js/27.45bceba5.js"><link rel="prefetch" href="/w2023/assets/js/28.3f49100e.js"><link rel="prefetch" href="/w2023/assets/js/29.dff6b604.js"><link rel="prefetch" href="/w2023/assets/js/30.0d01a8e4.js"><link rel="prefetch" href="/w2023/assets/js/31.cfbc8e9f.js"><link rel="prefetch" href="/w2023/assets/js/32.2bd8381f.js"><link rel="prefetch" href="/w2023/assets/js/33.c0fa7e80.js"><link rel="prefetch" href="/w2023/assets/js/34.a29cefed.js"><link rel="prefetch" href="/w2023/assets/js/35.26354f67.js"><link rel="prefetch" href="/w2023/assets/js/36.5d697666.js"><link rel="prefetch" href="/w2023/assets/js/37.19db9f95.js"><link rel="prefetch" href="/w2023/assets/js/38.388e9638.js"><link rel="prefetch" href="/w2023/assets/js/39.aa1380a5.js"><link rel="prefetch" href="/w2023/assets/js/4.c0130289.js"><link rel="prefetch" href="/w2023/assets/js/40.1e348976.js"><link rel="prefetch" href="/w2023/assets/js/5.9d721531.js"><link rel="prefetch" href="/w2023/assets/js/6.fec5c1cc.js"><link rel="prefetch" href="/w2023/assets/js/8.5b458cb5.js"><link rel="prefetch" href="/w2023/assets/js/9.2198ac92.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.9d277d19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2023/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2023/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2023/modules/week3/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/w2023/modules/week4/" class="sidebar-link">Week 4: Building RESTful APIs with Express</a></li><li><a href="/w2023/modules/week5/" class="sidebar-link">Week 5: Asynchronous Programming</a></li><li><a href="/w2023/modules/week6/" class="sidebar-link">Week 6: Middleware</a></li><li><a href="/w2023/modules/week7/" class="sidebar-link">Week 7: Midterm Project</a></li><li><a href="/w2023/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2023/modules/week9/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/w2023/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/w2023/modules/week11/" class="sidebar-link">Week 11: Authentication With Passport</a></li><li><a href="/w2023/modules/week12/" class="sidebar-link">Week 12: Data Santization, XSS and LoggingS</a></li><li><a href="/w2023/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/w2023/modules/week14/" aria-current="page" class="active sidebar-link">Week 14: Preparing for Production</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#post-authentication-redirect" class="sidebar-link">Post Authentication Redirect</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#mongoose-middleware" class="sidebar-link">Mongoose middleware</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#json-web-token" class="sidebar-link">JSON Web Token</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#generating-the-token" class="sidebar-link">Generating the token</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#authenticating-with-jwt" class="sidebar-link">Authenticating with JWT</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#my-own-pokemon" class="sidebar-link">My own pokemon</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#additional-routes" class="sidebar-link">Additional Routes</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#render" class="sidebar-link">Render</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#deploy-an-app-to-render-from-a-github-repository" class="sidebar-link">Deploy an App to Render from a GitHub Repository</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week14/#testing-our-deployment" class="sidebar-link">Testing our deployment</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 13</span><br> <span class="title">Preparing for Production</span></h1> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 mins)</li> <li>Post Authentication Redirect</li> <li>Mongoose middleware</li> <li>Storing auth session in JWT</li> <li>Adding <code>ownerId</code> to our resource</li> <li>Additional routes</li> <li>Render</li> <li>Deploy an App to Render from a GitHub Repository</li></ul> <hr> <h2 id="post-authentication-redirect"><a href="#post-authentication-redirect" class="header-anchor">#</a> Post Authentication Redirect</h2> <p>We currently have set that a user redirects to <code>/private</code> upon successful authentication, however, in practice we will want to redirect them back to the client. In addition, the client may want to redirect to a certain page. It is a bad user experience if I try to go a certain page, am requested to sign in, then I am sent back to the homepage instead of the page I originally wanted.</p> <p>To handle this dynamically, we will accept a <code>redirect_url</code> query param in our <code>auth/google</code> route, and use this as the redirect success url.</p> <p>To do this, we will have add a layer in front of the passport.authenticate middleware.</p> <p>Google accepts a state property to its oauth consent page, that will be sent back with the login response.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/router/auth.js</span>

authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// localhost: 3001/auth/google?redirect_url=http://localhost:3000/login-success</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> redirect_url <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span> <span class="token comment">// redirect_url = http://localhost:3000/login-success</span>

  <span class="token keyword">const</span> authenticator <span class="token operator">=</span> passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> redirect_url<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">authenticator</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can now expect the state property to appear in our <code>/auth/google/callback</code> route, and can use this as the redirect value, with <code>/</code> as a fallback if it was not supplied.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/router/auth.js</span>

authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google/callback&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&quot;/login&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> redirectUrl <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>state <span class="token operator">??</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>redirectUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="mongoose-middleware"><a href="#mongoose-middleware" class="header-anchor">#</a> Mongoose middleware</h2> <p>It can get confusing using the <code>_id</code> property given to use from mongo. Is it a string? Is it an object? Why is there a <code>_</code>?</p> <p>Mongoose has the ability to transform the data coming from the db using their middleware. Let's add an <code>id</code> property to our <code>User</code> to make our lives easier.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/models/User.js</span>

<span class="token operator">...</span>  
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// we can tell our scheama to perform a this callback every time toObject is called.</span>
<span class="token comment">// toObject is called by default with any of the find methods (find, findById, etc)</span>
UserSchema<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'toObject'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_doc<span class="token punctuation">,</span> ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>rets<span class="token punctuation">,</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> ret<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>id</code> of type string is now attached to every user!</p> <h2 id="json-web-token"><a href="#json-web-token" class="header-anchor">#</a> JSON Web Token</h2> <p>Because our server and client are on separate domains, we cannot simply use cookies stored in the browser. We will use the defacto industry standard <a href="https://jwt.io/introduction/" target="_blank" rel="noopener noreferrer">JSON Web Tokens (JWT)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. There are libraries for just about every popular programming language. Let's install the Node.js module.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">yarn</span> <span class="token function">add</span> jsonwebtoken
</code></pre></div><p>We will manually recreate what <code>passport</code> is doing with the <code>deserializeUser</code> and <code>serializeUser</code>, except instead of storing the userId in the session, we will store it in a <code>JWT</code>, and pass the JWT to the client, to be saved in <code>localstorage</code> or <code>sessionstorage</code></p> <p>You should read the full documentation on JWTs but here are two critical things to understand.</p> <ol><li><p>The payload is hashed, <strong>not encrypted</strong>. Anyone with some JavaScript can read it. So, never put sensitive data in the token payload.</p></li> <li><p>The token is cryptographically signed using a secret key on your sever. So we can validate that no one has altered the contents of the payload. Which means we can trust it.</p></li></ol> <p>Let's <a href="https://www.npmjs.com/package/jsonwebtoken" target="_blank" rel="noopener noreferrer">check the usage instructions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ...</p> <p>We need to require the library at the top.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/router/auth.js</span>

<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We will get the secret from our <code>.env</code> file.</p> <div class="language- extra-class"><pre class="language-text"><code>JWT_SECRET=super-secret-password
</code></pre></div><hr> <h2 id="generating-the-token"><a href="#generating-the-token" class="header-anchor">#</a> Generating the token</h2> <p>Just like for our session, we only want to save the user's id in our JWT token, so that we can use the id to lookup the user's data. This prevents holding stale data in the token in the event the user document is updated.</p> <p>After a successful return from google, passport will automatically add the user to the request, so we can access the user's <code>id</code> from here.</p> <p>Use the jsonwebtoken library and the secret from <code>process.env</code> to sign a new token, and send it with the redirectUrl to the client.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/router/auth.js</span>

authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google/callback&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&quot;/login&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> redirectUrl <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>state <span class="token operator">??</span> <span class="token string">'/'</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>redirectUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We will no longer worry about serializing / deserializing the user with passport, so we can clean up our middleware like so:</p> <div class="language-js extra-class"><pre class="language-js"><code>passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="authenticating-with-jwt"><a href="#authenticating-with-jwt" class="header-anchor">#</a> Authenticating with JWT</h2> <p>Now that the token has been generated, we will expect the client to store this token, and any requests that will come from the authenticated user will include this token in the headers.</p> <p>The popular place to store is in the <code>Authentication</code> header, using the format: <code>Bearer [token]</code>. We can use this knowledge to create a middleware function that will mimic the <code>passport.session()</code> middleware, attaching the user to <code>req.user</code> with a verified <code>JWT</code> or responding with a <code>401</code> if the token is missing or invalid.</p> <p>We will replace our isAuthenticated middleware function.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/middleware/isAuthenticated.js</span>

<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> verify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;jsonwebtoken&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> UnauthorizedError <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../utils/errors&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">isAuthenticated</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>authorization<span class="token operator">?.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;Bearer &quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnauthorizedError</span><span class="token punctuation">(</span><span class="token string">&quot;Please sign in&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnauthorizedError</span><span class="token punctuation">(</span><span class="token string">&quot;Please sign in&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      req<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
    
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnauthorizedError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">JWT error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> isAuthenticated<span class="token punctuation">;</span>
</code></pre></div><p>Test with postman!</p> <p>Follow the usual path to login <code>/auth/google</code>. We should see once we redirect <code>?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY0MWNkM2M5NmQ0N2I4NmQyYTA3NzU3YyIsImlhdCI6MTY4MTA1MTg3MH0.ZD_390iQB7-ZUDRlujRHkfGTxs4HoO-rvKiZD4uDgL0</code> in the url. Lets copy this token, and add it to the headers in Postman.</p> <p><img src="/w2023/assets/img/PostMan_token.7f809c9b.png" alt="postman picture"></p> <p>Success!!</p> <hr> <h2 id="my-own-pokemon"><a href="#my-own-pokemon" class="header-anchor">#</a> My own pokemon</h2> <p>Our pokemon app currently allows everyone to create pokemon, but no way to organize which pokemon you have made. I'd like to be able to keep track of the pokemon I have collected. Let's alter our pokemon model to have an <code>ownerId</code>, so we know who it belongs to.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/models/pokemon</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Schema<span class="token punctuation">,</span> model <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pokemonSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">abilities</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// add the following to connect a pokemon to a user</span>
  <span class="token literal-property property">ownerId</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">ref</span><span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;pokemon&quot;</span><span class="token punctuation">,</span> pokemonSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We can add a new route to <code>GET</code> only the pokemon that the authenticated user has created.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/router/pokemon.js</span>

pokemonRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/me'</span><span class="token punctuation">,</span> PokemonController<span class="token punctuation">.</span>getMyPokemon<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/controllers/pokemon.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">getMyPokemon</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pokemon <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">getMyPokemon</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> pokemon <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/services/pokemons.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">getMyPokemon</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ownerId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> myPokemon <span class="token operator">=</span> <span class="token keyword">await</span> Pokemon<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> ownerId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> myPokemon<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Don't forget to add to the exports!</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getAll<span class="token punctuation">,</span>
  <span class="token comment">// add here</span>
  getMyPokemon<span class="token punctuation">,</span>
  getOne<span class="token punctuation">,</span>
  create<span class="token punctuation">,</span>
  replace<span class="token punctuation">,</span>
  update<span class="token punctuation">,</span>
  deleteOne<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Test with postman!</p> <p>We should see an empty array here, as all the pokemon we have created so far don't have an <code>ownerId</code> yet.</p> <p>Lets modify our POST method to assign the ownerId.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/controllers/pokemon.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// we will send the req.user.id to the pokemon service here</span>
    <span class="token keyword">const</span> createdPokemon <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> createdPokemon <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/services/pokemon.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ownerId<span class="token punctuation">,</span> pokemonData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newPokemon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pokemon</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>pokemonData<span class="token punctuation">,</span>
    ownerId<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> newPokemon<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> newPokemon<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>We can see in Compass now, that any pokemon will be saved with the logged in user's id!</p> <p>Try the <code>api/pokemon/me</code> route now, and we should see our pokemon on the list!</p> <p><img src="/w2023/assets/img/pokemon_me_success.d822978c.png" alt="success pokemon fetch"></p> <p>It makes sense to only be able to edit / delete our own pokemon, so let's update the logic for replace, update and delete as well:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/controllers/pokemon.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">replace</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> replacedPokemon <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      req<span class="token punctuation">.</span>body
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> replacedPokemon <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> updatedPokemon <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      req<span class="token punctuation">.</span>body
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> updatedPokemon <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">deleteOne</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> deletedpokemon <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> deletedpokemon <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/services/pokemon.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">replace</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ownerId<span class="token punctuation">,</span> pokemonData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pokemonData<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token operator">!</span>pokemonData<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token operator">!</span>pokemonData<span class="token punctuation">.</span>abilities<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestError</span><span class="token punctuation">(</span><span class="token string">&quot;Name, Type and Abilities are required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> replacedPokemon <span class="token operator">=</span> <span class="token keyword">await</span> Pokemon<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id<span class="token punctuation">,</span> ownerId <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token operator">...</span>pokemonData<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">returnOriginal</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replacedPokemon<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pokemon with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> replacedPokemon<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ownerId<span class="token punctuation">,</span> updatedFields</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>updatedFields<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestError</span><span class="token punctuation">(</span><span class="token string">&quot;Nothing to update&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> updatedPokemon <span class="token operator">=</span> <span class="token keyword">await</span> Pokemon<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id<span class="token punctuation">,</span> ownerId <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token operator">...</span>updatedFields<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">returnOriginal</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updatedPokemon<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pokemon with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> updatedPokemon<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">deleteOne</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> ownerId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> deletedPokemon <span class="token operator">=</span> <span class="token keyword">await</span> Pokemon<span class="token punctuation">.</span><span class="token function">findOneAndDelete</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id<span class="token punctuation">,</span> ownerId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deletedPokemon<span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pokemon with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> deletedPokemon<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Our app is now more functional! A user can no create update and delete their own pokemon, and keep them separate from another users data!</p> <h2 id="additional-routes"><a href="#additional-routes" class="header-anchor">#</a> Additional Routes</h2> <p>Express allows us to have as many params as we want in our routes. Let's say we are making a pokemon game, and a pokemon's ability will do damage. Lets update our pokemon model to have an embedded Ability Schema</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> abilitySchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">damage</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">min</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">10</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span> 
<span class="token comment">// update the pokemonSchema's abilities here</span>
<span class="token literal-property property">abilities</span><span class="token operator">:</span> <span class="token punctuation">[</span>abilitySchema<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>Now, when we save a pokemon, each ability will automatically generate an _id, just like pokemon does!</p> <p><img src="/w2023/assets/img/embedded_abilities_success.f387ac2c.png" alt="success embedded"></p> <p>We can no use this id to look up a specific ability! Let's create 2 new routes: one to get all the abilities for a given pokemon, and another to get the details for a specific ability.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/router/pokemon.js</span>

pokemonRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/:id/abilities&quot;</span><span class="token punctuation">,</span> PokemonController<span class="token punctuation">.</span>getAbilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
pokemonRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/:pokemonId/abilities/:abilityId&quot;</span><span class="token punctuation">,</span> PokemonController<span class="token punctuation">.</span>getOneAbility<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/controllers/pokemon.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">getAbilities</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> abilities <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">getAbilities</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> abilities <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getOneAbility</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ability <span class="token operator">=</span> <span class="token keyword">await</span> PokemonService<span class="token punctuation">.</span><span class="token function">getOneAbility</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> ability <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/controllers/pokemon.js</span>

<span class="token keyword">const</span> <span class="token function-variable function">getAbilities</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> foundPokemon <span class="token operator">=</span> <span class="token keyword">await</span> Pokemon<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundPokemon<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pokemon with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> foundPokemon<span class="token punctuation">.</span>abilities<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getOneAbility</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">pokemonId<span class="token punctuation">,</span> abilityId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> foundPokemon <span class="token operator">=</span> <span class="token keyword">await</span> Pokemon<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundPokemon<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pokemon with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> ability <span class="token operator">=</span> foundPokemon<span class="token punctuation">.</span>abilities<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>_id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> _id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> abilityId<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ability<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Ability with id </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ability<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> ability<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Don't forget to update the exports!</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  getAll<span class="token punctuation">,</span>
  getOne<span class="token punctuation">,</span>
  <span class="token comment">// add these</span>
  getAbilities<span class="token punctuation">,</span>
  getOneAbility<span class="token punctuation">,</span>

  create<span class="token punctuation">,</span>
  replace<span class="token punctuation">,</span>
  update<span class="token punctuation">,</span>
  deleteOne<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="render"><a href="#render" class="header-anchor">#</a> Render</h2> <p><a href="https://render.com/" target="_blank" rel="noopener noreferrer">Render.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> provides website hosting from a worldwide CDN (content delivery network). It’s a network of servers that store your website files and deliver the files extremely rapidly when people visit your website. Apart from speed, three features stand out:</p> <ul><li>Website hosting is free for static sites.</li> <li>You can use your own custom domain for free.</li> <li>Your website deploys automatically from GitHub.</li></ul> <h2 id="deploy-an-app-to-render-from-a-github-repository"><a href="#deploy-an-app-to-render-from-a-github-repository" class="header-anchor">#</a> Deploy an App to Render from a GitHub Repository</h2> <p>Go to <a href="https://render.com/" target="_blank" rel="noopener noreferrer">Render.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and select <code>Get Started</code> to create your account.</p> <p><img src="/w2023/assets/img/render_01.05cfce10.png" alt="Render Get Started"></p> <p>It's best to sign up with GitHub first so you can click <code>GitHub</code> to authorize and create your account.</p> <p><img src="/w2023/assets/img/render_02.afac0bf2.png" alt="Render Git login"></p> <p>Once signed up and logged in to your account, you will see a dashboard like this:</p> <p><img src="/w2023/assets/img/render_03.e0de7922.png" alt="Render Dashboard"></p> <p>To deploy a Node.js application, click on the <code>New Web Service</code> button under the Web Services option.</p> <p>You can also click on the New <code>+</code> button displayed in the header just before your profile picture and select <code>Web Service option</code>.</p> <p><img src="/w2023/assets/img/render_04.50fd5184.png" alt="Render Dashboard 1"></p> <p>Once clicked, you will see the following screen:</p> <p><img src="/w2023/assets/img/render_05.2f7493e9.png" alt="Render Dashboard 2"></p> <p>Next up is to choose your repository, and click <code>connect</code></p> <p><img src="/w2023/assets/img/render_06.11876234.png" alt="Render Dashboard 3"></p> <p>Here, for the <code>Name</code> field, enter the a short and simple name to identify your website.</p> <p>Note: keep the Name value simple because it will become your application URL once the application is deployed. So if I enter <code>github-mad9124</code> as the value for the <code>Name</code>, my application URL will become <code>https://github-mad9124.onrender.com</code>.</p> <p>So make sure to enter a short and meaningful value for <code>Name</code>.</p> <p>For Build Command enter <code>yarn</code> as the value which is equivalent to the <code>yarn install</code> command, and for the Start Command enter <code>yarn start</code> as the value, assuming you have set up the script in <code>package.json</code>.</p> <p>If you scroll down a bit more, you will see an <code>Advanced</code> button. Our application is using many environment variables, you can enter them in the Advanced settings as shown below. You can also add your <code>.env</code> files so you don't need to enter them manually one by one.</p> <p><img src="/w2023/assets/img/render_07.f8bdd17d.png" alt="Render Env"></p> <p>The default version of Node used by Render will not work with mongoose. We need to tell Render to use a late version of node so that it will work. We can do this by setting the <code>NODE_VERSION</code> environment variable. We will set it to <code>18.13.0</code>.</p> <p><strong>Note</strong>: the <code>Auto-Deploy</code> field has default value of <code>Yes</code> – so once you push your code changes to GitHub repository, they will be automatically deployed to Render.</p> <p>Click on the the <code>Create Web Service</code> button to start the deployment process. Once the deployment is completed, you will see your application is deployed Live as shown below:</p> <p><img src="/w2023/assets/img/render_08.570f4d86.png" alt="Render Deployed"></p> <h2 id="testing-our-deployment"><a href="#testing-our-deployment" class="header-anchor">#</a> Testing our deployment</h2> <p>Fire up Postman, and let's check our <code>GET</code> endpoint.</p> <p><img src="/w2023/assets/img/render_09.ec4b120c.png" alt="Render Test"></p> <p>It works! Now we can test our other endpoints to make sure we can do full CRUD operation via a newly hosted API on Render.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/10/2023, 4:58:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2023/modules/week13/" class="prev">
        Week 13: Testing with Jest
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/w2023/assets/js/app.a268f35f.js" defer></script><script src="/w2023/assets/js/3.30d56026.js" defer></script><script src="/w2023/assets/js/7.054fdd44.js" defer></script><script src="/w2023/assets/js/16.1e8637e4.js" defer></script>
  </body>
</html>
