<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 6: Middleware | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.9d277d19.css" as="style"><link rel="preload" href="/w2023/assets/js/app.a268f35f.js" as="script"><link rel="preload" href="/w2023/assets/js/3.30d56026.js" as="script"><link rel="preload" href="/w2023/assets/js/32.2bd8381f.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.b7c1a16d.js"><link rel="prefetch" href="/w2023/assets/js/11.f2aecf7a.js"><link rel="prefetch" href="/w2023/assets/js/12.7642e84c.js"><link rel="prefetch" href="/w2023/assets/js/13.5e27a08c.js"><link rel="prefetch" href="/w2023/assets/js/14.4b92b91c.js"><link rel="prefetch" href="/w2023/assets/js/15.628eb87b.js"><link rel="prefetch" href="/w2023/assets/js/16.1e8637e4.js"><link rel="prefetch" href="/w2023/assets/js/17.feedfd9c.js"><link rel="prefetch" href="/w2023/assets/js/18.4d23c18f.js"><link rel="prefetch" href="/w2023/assets/js/19.bdc3f6f0.js"><link rel="prefetch" href="/w2023/assets/js/2.c49fd8f9.js"><link rel="prefetch" href="/w2023/assets/js/20.7bb0ba89.js"><link rel="prefetch" href="/w2023/assets/js/21.bbf158ab.js"><link rel="prefetch" href="/w2023/assets/js/22.04ba04d6.js"><link rel="prefetch" href="/w2023/assets/js/23.b3f8222f.js"><link rel="prefetch" href="/w2023/assets/js/24.74d3f93b.js"><link rel="prefetch" href="/w2023/assets/js/25.5343cc2e.js"><link rel="prefetch" href="/w2023/assets/js/26.9f73a8bf.js"><link rel="prefetch" href="/w2023/assets/js/27.45bceba5.js"><link rel="prefetch" href="/w2023/assets/js/28.3f49100e.js"><link rel="prefetch" href="/w2023/assets/js/29.dff6b604.js"><link rel="prefetch" href="/w2023/assets/js/30.0d01a8e4.js"><link rel="prefetch" href="/w2023/assets/js/31.cfbc8e9f.js"><link rel="prefetch" href="/w2023/assets/js/33.c0fa7e80.js"><link rel="prefetch" href="/w2023/assets/js/34.a29cefed.js"><link rel="prefetch" href="/w2023/assets/js/35.26354f67.js"><link rel="prefetch" href="/w2023/assets/js/36.5d697666.js"><link rel="prefetch" href="/w2023/assets/js/37.19db9f95.js"><link rel="prefetch" href="/w2023/assets/js/38.388e9638.js"><link rel="prefetch" href="/w2023/assets/js/39.aa1380a5.js"><link rel="prefetch" href="/w2023/assets/js/4.c0130289.js"><link rel="prefetch" href="/w2023/assets/js/40.1e348976.js"><link rel="prefetch" href="/w2023/assets/js/5.9d721531.js"><link rel="prefetch" href="/w2023/assets/js/6.fec5c1cc.js"><link rel="prefetch" href="/w2023/assets/js/7.054fdd44.js"><link rel="prefetch" href="/w2023/assets/js/8.5b458cb5.js"><link rel="prefetch" href="/w2023/assets/js/9.2198ac92.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.9d277d19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2023/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2023/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2023/modules/week3/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/w2023/modules/week4/" class="sidebar-link">Week 4: Building RESTful APIs with Express</a></li><li><a href="/w2023/modules/week5/" class="sidebar-link">Week 5: Asynchronous Programming</a></li><li><a href="/w2023/modules/week6/" aria-current="page" class="active sidebar-link">Week 6: Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#week-6-middleware" class="sidebar-link">Week 6: Middleware</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#what-is-middleware" class="sidebar-link">What is middleware</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#types-of-middleware" class="sidebar-link">Types of middleware</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#common-use-cases" class="sidebar-link">Common use cases</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#logging" class="sidebar-link">Logging</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#router-modules" class="sidebar-link">Router Modules</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#image-handling" class="sidebar-link">Image Handling</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#validation" class="sidebar-link">Validation</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#exercise" class="sidebar-link">Exercise</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week6/#more-resources" class="sidebar-link">More resources</a></li></ul></li><li><a href="/w2023/modules/week7/" class="sidebar-link">Week 7: Midterm Project</a></li><li><a href="/w2023/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2023/modules/week9/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/w2023/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/w2023/modules/week11/" class="sidebar-link">Week 11: Authentication With Passport</a></li><li><a href="/w2023/modules/week12/" class="sidebar-link">Week 12: Data Santization, XSS and LoggingS</a></li><li><a href="/w2023/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/w2023/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="week-6-middleware"><a href="#week-6-middleware" class="header-anchor">#</a> Week 6: Middleware</h2> <ul><li>AMA (15 min)</li> <li>What is middleware
<ul><li>Types of middleware</li> <li>Common use cases</li></ul></li> <li>Logging</li> <li>Router modules</li> <li>Image Handling</li> <li>Validation</li> <li>Exercise</li> <li>More resources</li></ul> <h2 id="what-is-middleware"><a href="#what-is-middleware" class="header-anchor">#</a> What is middleware</h2> <p>Middleware functions are used to encapsulate functionality that you want to apply to multiple routes without repeating the code in every route handler. They run before the route handlers are evaluated and may be chained together. Each middleware function can either end the request or pass control to the next function in the pipeline, until the final route handler is reached.</p> <p>Middleware in ExpressJS and Node.js is a powerful feature that allows you to manipulate the incoming request and outgoing response in your application. It acts as an intermediary between the request and response, allowing you to perform tasks such as authentication, logging, and data validation.</p> <p>In ExpressJS, middleware functions are added to the middleware stack using the <code>app.use</code> method. These functions take three arguments: <code>req</code>, <code>res</code>, and <code>next</code>. The <code>req</code> argument is the incoming request object, the <code>res</code> argument is the outgoing response object, and the <code>next</code> argument is a function that is called to move to the <code>next</code> middleware function in the stack.</p> <h2 id="types-of-middleware"><a href="#types-of-middleware" class="header-anchor">#</a> Types of middleware</h2> <p>An Express application can use the following types of middleware:</p> <ul><li>Application-level middleware</li> <li>Router-level middleware</li> <li>Error-handling middleware
<ul><li>different function signature</li></ul></li> <li>Built-in middleware
<ul><li>express.json()</li> <li>express.urlencoded()x</li> <li>express.static</li></ul></li> <li>Third-party middleware
<ul><li><a href="npmjs.com/search?q=express%20middleware">over 5000 packages on NPM</a></li></ul></li></ul> <h2 id="common-use-cases"><a href="#common-use-cases" class="header-anchor">#</a> Common use cases</h2> <ul><li>router modules</li> <li>validation</li> <li>image handling</li> <li>error handling</li> <li>enforcing security best practices</li></ul> <h2 id="logging"><a href="#logging" class="header-anchor">#</a> Logging</h2> <p>Let's create a simple middleware function that logs information about the incoming request. To do this, we'll use the <code>console.log</code> method to log the request method, path, and date and time of the request.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> request made to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>We can then use this middleware function in our application by adding it to the middleware stack using the app.use method. This will ensure that the function is called for every incoming request.</p> <h2 id="router-modules"><a href="#router-modules" class="header-anchor">#</a> Router Modules</h2> <p>Middleware refers to the functions that are executed before a request reaches the route handler. These functions can perform tasks such as logging, authentication, and data validation. They are added to the middleware stack using the app.use method in ExpressJS and are executed in the order they are added.</p> <p>Routes refer to the endpoints in your application that handle incoming HTTP requests. They are defined using the methods on the ExpressJS app object, such as app.get, app.post, app.put, and app.delete. The route handler is a function that is executed when a matching request is received.</p> <p>Here is an example of how middleware and routes can work together in an ExpressJS application:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a middleware function that logs the incoming request</span>
<span class="token keyword">const</span> <span class="token function-variable function">logMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> request made to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Use the log middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define a route that returns &quot;Hello World&quot;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start the server</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server started on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this example, we define a middleware function that logs the incoming request, and use it in our application using the <code>app.use</code> method. We also define a simple route that returns &quot;Hello World&quot;.</p> <p>When a request is made to the &quot;/&quot; endpoint, the logMiddleware function will be executed first, logging the incoming request to the console. The request will then be passed to the route handler, which will return &quot;Hello World&quot; as the response.</p> <p>This is just a simple example of how middleware and routes can work together in an ExpressJS and Node.js application. In a real-world application, you would likely have more complex middleware functions and routes, and may also use additional libraries such as Mongoose for data storage.</p> <h2 id="image-handling"><a href="#image-handling" class="header-anchor">#</a> Image Handling</h2> <p>In a software developmet for Web/Mobile images plays a crucial role so let's learn how to handle image uploads in an ExpressJS application using middleware. We'll be using the <a href="https://www.npmjs.com/package/multer" target="_blank" rel="noopener noreferrer"><code>multer</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> library to handle the image file upload process.</p> <p>First, you need to install <a href="https://www.npmjs.com/package/multer" target="_blank" rel="noopener noreferrer"><code>multer</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in your project. You can do this by running the following command in your terminal:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm install multer
</code></pre></div><p>Next, you need to require <code>multer</code> in your application and set up a storage engine for the uploaded files. There are several storage engines available in <code>multer</code>, but in this tutorial, we'll be using the <code>diskStorage</code> engine, which will store the uploaded files on the server's disk.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> storage <span class="token operator">=</span> multer<span class="token punctuation">.</span><span class="token function">diskStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">destination</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'public/uploads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">filename</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token punctuation">.</span>originalname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In the code above, we set up the <code>diskStorage</code> engine by passing an object to its constructor. The object has two properties: <code>destination</code> and <code>filename</code>. The <code>destination</code> property is a function that takes three arguments: <code>req</code>, <code>file</code>, and <code>cb</code>. The function specifies where the uploaded files should be stored on the server. In this case, the files will be stored in the <code>public/uploads</code> directory. The <code>filename</code> property is another function that takes three arguments and specifies how the uploaded files should be named. In this case, the files will be named with a timestamp and the original file name.</p> <p>Once the storage engine is set up, we need to create a middleware function that will handle the file upload process. This function will take care of parsing the incoming request, extracting the file, and storing it on the server.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> storage <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span> upload<span class="token punctuation">.</span><span class="token function">single</span><span class="token punctuation">(</span><span class="token string">'image'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Image uploaded successfully'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">uploads/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>file<span class="token punctuation">.</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In the code above, we create a <code>upload</code> middleware function using the <code>multer</code> function and passing in the <code>storage</code> engine we set up earlier. We then use the <code>upload.single</code> method to specify that we're only allowing a single file to be uploaded. The method takes two arguments: the name of the file input in the form and the middleware function that will handle the file upload process. In this case, the middleware function will return a <code>200 OK</code> response with a message indicating that the image was uploaded successfully, as well as the URL of the uploaded image.</p> <p>With these steps, you have a basic setup for handling image uploads in an ExpressJS application using middleware. You can extend this setup by adding more functionality, such as image resizing, cropping, and validation, using additional middleware functions.</p> <h2 id="validation"><a href="#validation" class="header-anchor">#</a> Validation</h2> <p>Validation is an important aspect of building a robust and secure web application in ExpressJS and Node.js. It ensures that incoming data from the client is valid before processing it further.</p> <p>Here's an example of how to use middleware for data validation in ExpressJS:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">validateMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name <span class="token operator">||</span> <span class="token operator">!</span>age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'Name and age are required'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> validateMiddleware<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Add the new user to the database or in an array</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this example, we use destructuring to extract the <code>name</code> and <code>age</code> properties from the <code>req.body</code> object. We then check if these properties are present and return a <code>400 Bad Request</code> response if they are not. If the properties are present, the function calls <code>next</code> to move to the next middleware function in the stack or to the route handler if there are no more middleware functions.</p> <p>It's also possible to use external libraries, such as <a href="https://joi.dev/" target="_blank" rel="noopener noreferrer">Joi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://express-validator.github.io/docs/" target="_blank" rel="noopener noreferrer">Express Validator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, for more complex validation logic. These libraries provide a convenient way to write validation rules and return informative error messages in case of validation failure.</p> <p>Middleware validation is a crucial aspect of building a secure and reliable web application. It helps ensure that incoming data from the client is valid before processing it further, and helps prevent security issues and unexpected behavior in the application.</p> <h2 id="exercise"><a href="#exercise" class="header-anchor">#</a> Exercise</h2> <ul><li>Create a new project in your mad9124 repo under <code>week6</code> and install <code>express</code> and <code>nodemon</code>.</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>  <span class="token function">yarn</span> init 
  <span class="token function">yarn</span> <span class="token function">add</span> express
  <span class="token function">yarn</span> <span class="token function">add</span> <span class="token parameter variable">-D</span> nodemon
</code></pre></div><ul><li>Add your <code>start</code> and <code>dev</code> scripts to package.json:</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token comment">// package.json</span>
  ...
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon src/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node src/index.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Create the src/index.js file and add the express app basics.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token string">'use strict'</span>

  <span class="token keyword">const</span> expres <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Application level middleware ehre</span>

  <span class="token comment">// Routes here</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Server Runnimg..'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">App listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>Create a new middleware function that will validate the incoming user data. This function should check if the <code>name</code> and <code>email</code> properties are present in the <code>req.body</code> object. If either of these properties is missing, return a <code>400 Bad Request</code> response with a message <code>&quot;Name and email are required&quot;</code>.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/middleware/validateUserData.js</span>
<span class="token keyword">const</span> <span class="token function-variable function">validateUserData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// your code here</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> validateUserData<span class="token punctuation">;</span>
</code></pre></div><ul><li>Create a new route for adding (Post request) a user. This route should use the validation middleware created in step 2 and add the user to an in-memory database (an array). If the validation passes, return a <code>201 Created</code> response with the newly created user object.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// src/routes/user.js</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  userRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>Make sure to import and export correctly to and from each module</li> <li>Start the Express server and test the user creation route using a Postman.</li> <li>Once you are confident it is running as expected, commit your changes, push to github, and submit with a link to your github repo in Brightspace!</li></ul> <h2 id="more-resources"><a href="#more-resources" class="header-anchor">#</a> More resources</h2> <ul><li><a href="https://expressjs.com/en/guide/writing-middleware.html" target="_blank" rel="noopener noreferrer">Writing middleware for use in Express apps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://youtu.be/MIr1oxQ3pao" target="_blank" rel="noopener noreferrer">Express JS - What the Heck is Middleware<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://expressjs.com/en/4x/api.html#router" target="_blank" rel="noopener noreferrer">Router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://youtu.be/iM_S4RczozU" target="_blank" rel="noopener noreferrer">Express JS - Router and Routes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/13/2023, 9:38:25 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2023/modules/week5/" class="prev">
        Week 5: Asynchronous Programming
      </a></span> <span class="next"><a href="/w2023/modules/week7/">
        Week 7: Midterm Project
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/w2023/assets/js/app.a268f35f.js" defer></script><script src="/w2023/assets/js/3.30d56026.js" defer></script><script src="/w2023/assets/js/32.2bd8381f.js" defer></script>
  </body>
</html>
