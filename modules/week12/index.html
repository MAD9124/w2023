<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 12: Data Santization, XSS and LoggingS | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.9d277d19.css" as="style"><link rel="preload" href="/w2023/assets/js/app.a268f35f.js" as="script"><link rel="preload" href="/w2023/assets/js/3.30d56026.js" as="script"><link rel="preload" href="/w2023/assets/js/12.7642e84c.js" as="script"><link rel="preload" href="/w2023/assets/js/16.1e8637e4.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.b7c1a16d.js"><link rel="prefetch" href="/w2023/assets/js/11.f2aecf7a.js"><link rel="prefetch" href="/w2023/assets/js/13.5e27a08c.js"><link rel="prefetch" href="/w2023/assets/js/14.4b92b91c.js"><link rel="prefetch" href="/w2023/assets/js/15.628eb87b.js"><link rel="prefetch" href="/w2023/assets/js/17.feedfd9c.js"><link rel="prefetch" href="/w2023/assets/js/18.4d23c18f.js"><link rel="prefetch" href="/w2023/assets/js/19.bdc3f6f0.js"><link rel="prefetch" href="/w2023/assets/js/2.c49fd8f9.js"><link rel="prefetch" href="/w2023/assets/js/20.7bb0ba89.js"><link rel="prefetch" href="/w2023/assets/js/21.bbf158ab.js"><link rel="prefetch" href="/w2023/assets/js/22.04ba04d6.js"><link rel="prefetch" href="/w2023/assets/js/23.b3f8222f.js"><link rel="prefetch" href="/w2023/assets/js/24.74d3f93b.js"><link rel="prefetch" href="/w2023/assets/js/25.5343cc2e.js"><link rel="prefetch" href="/w2023/assets/js/26.9f73a8bf.js"><link rel="prefetch" href="/w2023/assets/js/27.45bceba5.js"><link rel="prefetch" href="/w2023/assets/js/28.3f49100e.js"><link rel="prefetch" href="/w2023/assets/js/29.dff6b604.js"><link rel="prefetch" href="/w2023/assets/js/30.0d01a8e4.js"><link rel="prefetch" href="/w2023/assets/js/31.cfbc8e9f.js"><link rel="prefetch" href="/w2023/assets/js/32.2bd8381f.js"><link rel="prefetch" href="/w2023/assets/js/33.c0fa7e80.js"><link rel="prefetch" href="/w2023/assets/js/34.a29cefed.js"><link rel="prefetch" href="/w2023/assets/js/35.26354f67.js"><link rel="prefetch" href="/w2023/assets/js/36.5d697666.js"><link rel="prefetch" href="/w2023/assets/js/37.19db9f95.js"><link rel="prefetch" href="/w2023/assets/js/38.388e9638.js"><link rel="prefetch" href="/w2023/assets/js/39.aa1380a5.js"><link rel="prefetch" href="/w2023/assets/js/4.c0130289.js"><link rel="prefetch" href="/w2023/assets/js/40.1e348976.js"><link rel="prefetch" href="/w2023/assets/js/5.9d721531.js"><link rel="prefetch" href="/w2023/assets/js/6.fec5c1cc.js"><link rel="prefetch" href="/w2023/assets/js/7.054fdd44.js"><link rel="prefetch" href="/w2023/assets/js/8.5b458cb5.js"><link rel="prefetch" href="/w2023/assets/js/9.2198ac92.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.9d277d19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2023/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2023/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2023/modules/week3/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/w2023/modules/week4/" class="sidebar-link">Week 4: Building RESTful APIs with Express</a></li><li><a href="/w2023/modules/week5/" class="sidebar-link">Week 5: Asynchronous Programming</a></li><li><a href="/w2023/modules/week6/" class="sidebar-link">Week 6: Middleware</a></li><li><a href="/w2023/modules/week7/" class="sidebar-link">Week 7: Midterm Project</a></li><li><a href="/w2023/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2023/modules/week9/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/w2023/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/w2023/modules/week11/" class="sidebar-link">Week 11: Authentication With Passport</a></li><li><a href="/w2023/modules/week12/" aria-current="page" class="active sidebar-link">Week 12: Data Santization, XSS and LoggingS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#better-debugging" class="sidebar-link">Better debugging</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#environment-variables" class="sidebar-link">Environment Variables</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#important-note" class="sidebar-link">IMPORTANT NOTE</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#sanitization" class="sidebar-link">Sanitization</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#xss-protection" class="sidebar-link">XSS Protection</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#recursion" class="sidebar-link">Recursion</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#what" class="sidebar-link">What?</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#why" class="sidebar-link">Why?</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#logging" class="sidebar-link">Logging</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#winston" class="sidebar-link">Winston</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#node-env" class="sidebar-link">NODE_ENV</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#generate-jwt-secret" class="sidebar-link">Generate JWT Secret</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#compression" class="sidebar-link">Compression</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#security-middleware" class="sidebar-link">Security Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#cors" class="sidebar-link">CORS</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#helmet" class="sidebar-link">Helmet</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#npm-audit" class="sidebar-link">NPM audit</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#assignment" class="sidebar-link">Assignment</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week12/#more-readings" class="sidebar-link">More readings</a></li></ul></li><li><a href="/w2023/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/w2023/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 8</span><br> <span class="title">Data Santization, XSS and Logging</span></h1> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 mins)</li> <li>Better Debugging</li> <li>Santization</li> <li>XSS</li> <li>Logging</li></ul> <h2 id="better-debugging"><a href="#better-debugging" class="header-anchor">#</a> Better debugging</h2> <p>Before we dig into recommended practices for guarding against data corruption and scripting attacks through input data validation and sanitization, let's add another tool to our development toolbox.</p> <p>The <a href="https://www.npmjs.com/package/debug" target="_blank" rel="noopener noreferrer">debug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM module is a better <code>console.log</code> that you can turn on and off with an environment variable instead of commenting out the debugging statements in your code. It is used internally by all of the modules in the Express framework, and we can use it in our modules as well.</p> <p>Install debug as a project dependency.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm install debug
</code></pre></div><p>Make it available in <code>app.js</code> and set the namespace to the application name.</p> <p>Set the primary namespace</p> <p>The primary debug namespace should match the name property in package.json.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token string">'use strict'</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'week12'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./startup/database'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// IIFE</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Express is listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>To keep the main entry module for our project (app.js) as clean as possible. It is a good practice to move one-time set-up activities, like connecting to the database, into separate modules in a /startup or a /bootstrap folder.</p> <p>Put your Mongoose connection set-up code from week 6 into a new module called <code>/startup/database.js</code>.</p> <p>Then at the top of that file, require the debug module setting the namespace to week7:db and change any <code>console.log()</code> statements to <code>debug()</code> statements. The completed code should look like this.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'week7:db'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mongoose
    <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mongodb://localhost:27017/mad9124</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Connected to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error connecting to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div> <h2 id="environment-variables"><a href="#environment-variables" class="header-anchor">#</a> Environment Variables</h2> <p>Remember</p> <p>The debug module suppresses output by default.</p> <p>If you run the app now with <code>node app.js</code> it will not output anything to the console. You need to activate it by setting the <code>DEBUG</code> environment variable to our application namespace before running the application.</p> <div class="language-javascrit extra-class"><pre class="language-text"><code>DEBUG=week12 node app.js
</code></pre></div><p>Hmmm ... still not quite right. We only saw the debug message from app.js, not from the database connection module. Debug allows us to be very selective about which module's messages we want to see. If we run it again with ...</p> <div class="language- extra-class"><pre class="language-text"><code>DEBUG=week12:db node app.js
</code></pre></div><p>... now we only see the database connection message.</p> <p>To see all related namespaces we can use the * wildcard character.</p> <div class="language- extra-class"><pre class="language-text"><code>DEBUG=week12:* node app.js
</code></pre></div><p>DEBUG=week12* node app.js
Now you will see any debug output where the namespace starts with <code>week12</code>.</p> <p>The application start-up command is starting to get long. What if we want to add some other environment variables like <code>NODE_ENV</code>, <code>PORT</code> or <code>API_KEY</code>?</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token constant">DEBUG</span><span class="token operator">=</span>week12<span class="token operator">*</span> <span class="token constant">NODE_ENV</span><span class="token operator">=</span>dev <span class="token constant">PORT</span><span class="token operator">=</span><span class="token number">3000</span> <span class="token constant">API_KEY</span><span class="token operator">=</span>91ij08<span class="token operator">-</span>1fehi<span class="token operator">=</span>1feef node app<span class="token punctuation">.</span>js
</code></pre></div><p>There is a library <code>dotenv</code> that will take a special file called <code>.env</code>, and automatically add all the values from the file as environment files to our node application.</p> <p>Install the library:</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add dotenv
</code></pre></div><p>And add it to the very top of our index.js file. We can simply require the configuration function, and it will set everything up for us!</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv/config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// .env</span>
<span class="token constant">NODE_ENV</span><span class="token operator">=</span>development
<span class="token constant">PORT</span><span class="token operator">=</span><span class="token number">3000</span>
<span class="token constant">DEBUG</span><span class="token operator">=</span>week12<span class="token operator">:</span><span class="token operator">*</span>
<span class="token constant">API_KEY</span><span class="token operator">=</span>91ij08<span class="token operator">-</span>1fehi<span class="token operator">=</span>1feef
</code></pre></div><p>With this easy setup, we can easily keep track of our environment variables!</p> <h2 id="important-note"><a href="#important-note" class="header-anchor">#</a> IMPORTANT NOTE</h2> <p><em>MAKE SURE TO ADD .env TO YOUR .gitinore FILE!!!!!</em></p> <p><code>.env</code> files often contatin sensitive information that shouldn't be shared with github, and should not be committed. Instead, we make a <code>.env.example</code> file, so that anyone who clones our repo knows that these values are needed for our application to run, but won't know the exact sensetive values (like passwords or api keys). It should look like this:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// .env</span>
<span class="token constant">NODE_ENV</span><span class="token operator">=</span>
<span class="token constant">PORT</span><span class="token operator">=</span>
<span class="token constant">DEBUG</span><span class="token operator">=</span>
<span class="token constant">API_KEY</span><span class="token operator">=</span>
</code></pre></div><h1 id="npm-scripts"><a href="#npm-scripts" class="header-anchor">#</a> NPM Scripts</h1> <p>Add a start script for production and a dev script to use with our local development environment.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node app.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon app.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>Now you can start your development server by running ...</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>yarn dev
</code></pre></div><p>Or you can start up in production mode with <code>yarn start</code>.</p> <blockquote><p>We have more configuration work to do before we are ready for production mode. We will cover that in a few weeks.</p></blockquote> <h2 id="sanitization"><a href="#sanitization" class="header-anchor">#</a> Sanitization</h2> <p>The very nature of our application is to take user input and act on it in some way, either to store information or searching and filtering information from the database. The data stored is ultimately returned to the client application.</p> <p>This means that a web service application is inherently vulnerable to a variety of malicious attacks.</p> <p>We cannot trust any data coming from the client application. It might not be our code. It may have been hacked. A malicious actor may be using it to directly input data formatted to cause our system to malfunction.</p> <p><a href="https://owasp.org/" target="_blank" rel="noopener noreferrer">The Open Web Application Security Project (OWASP)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is an excellent resource for staying up to date on application security risks and best practices. Among their many resources, the annual <a href="https://github.com/OWASP/API-Security/raw/master/2019/en/dist/owasp-api-security-top-10.pdf" target="_blank" rel="noopener noreferrer">OWASP Top 10 Critical Web Application Security Risks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> should be on your reading list.</p> <p>Let's look at solving the two most damaging attack types: Cross-site scripting (XSS) and Database Injection. To do that, we need to filter and cleanse all incoming data.</p> <h2 id="xss-protection"><a href="#xss-protection" class="header-anchor">#</a> XSS Protection</h2> <p>To help protect against <a href="https://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank" rel="noopener noreferrer">Cross-site scripting (XSS) attacks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>you need to strip out any HTML or script tags from the input values so that they would not be interpreted as scripts or alter the browser rendering of any returned data. You can use the <a href="https://www.npmjs.com/package/xss" target="_blank" rel="noopener noreferrer">xss<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM package to solve this problem.</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install xss
</code></pre></div><p>Build a small middleware function to implement this behaviour. Create a new file in the <code>middleware</code> folder called <code>sanitizeBody.js</code>. Require the <code>debug</code> and <code>xss</code> modules at the top. Then add an empty middleware function signature. (We will fill in the logic in the next step.)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'sanitize:body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">sanitizeBody</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// sanitization logic goes here</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sanitizeBody<span class="token punctuation">;</span>
</code></pre></div><blockquote><p>It is a good practice not to take destructive action on the original request body. So, make a copy to work with and set the resulting sanitized version as a new property of the request object that downstream route handlers can access.</p></blockquote> <p>Start by stripping out any <code>id</code>, or <code>_id</code> properties. We never want those.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
</code></pre></div><p>The xss module applies its filter rules to strings. To apply it to the various properties of our user supplied data, we will need to loop over the members of the req.body object with a for...in loop.</p> <p>The xss function takes an optional configuration object to customize how it works.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// empty, means filter out all tags</span>
    <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// filter out all HTML not in the whitelist</span>
    <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token comment">// the script tag is a special case, we need</span>
    <span class="token comment">// to filter out its content</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Lastly set the modified attributes as the value of a new req.sanitizedBody property and then call next(). The whole thing should look similar to this.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'sanitize:body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">sanitizeBody</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span>attributes<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">sanitizedBody</span><span class="token operator">:</span> attributes<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span>sanitizedBody <span class="token operator">=</span> attributes<span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sanitizeBody<span class="token punctuation">;</span>
</code></pre></div><p>OK, we have our body sanitizer middleware function. How do we use it?</p> <p>Remember, Express route method declarations can take more than one callback function. This lets us call one or more middleware functions directly for any given route.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> routeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>So, in our /routes/cars.js module, we could do this ...</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// router/student.js</span>

studentRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> studentController<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// controllers/students.js</span>
<span class="token keyword">const</span> sanitizeBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/sanitizeBody'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> StudentService <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./services/Student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ... other set-up</span>

<span class="token keyword">const</span> <span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newStudent <span class="token operator">=</span> <span class="token keyword">await</span> StudentService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">data</span><span class="token operator">:</span> newStudent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You can now be reasonably confident that only plain text strings will be passed to Mongoose for validation. Potentially malicious HTML and JavaScript will be removed from input strings.</p> <p>You can test it with Postman.</p> <p><img src="/w2023/assets/img/screenshot-postman-xss-test.72d9c06c.png" alt="screenshot of Postman test"></p> <p>It worked!</p> <p>But wait. What if the payload attributes are not simple strings? We need to refactor the sanitizeBody middleware to call itself recursively for more complex data structures.</p> <h2 id="recursion"><a href="#recursion" class="header-anchor">#</a> Recursion</h2> <p>From <a href="https://javascript.info/recursion" target="_blank" rel="noopener noreferrer">The Modern JavaScript Tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>When a function solves a task, in the process it can call many other functions. A partial case of this is when a function calls itself. That’s called recursion.</p> <p>Start by creating a new function called stripTags. It should take a single argument - let's call it payload. Now cut the for...in loop from the main function and paste it into the new one. As a best practice, we should not mutate the original payload object that is passed in, so let's make a copy of that with the line let attributes = {...payload}. Don't forget to return the sanitized attributes at the end of this new function.</p> <p>Then call the new stripTags function from within the primary function. The refactored middleware should now look like this.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'sanitize:body'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">stripTags</span> <span class="token operator">=</span> <span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>payload<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> attributes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">sanitizeBody</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">body</span><span class="token operator">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span>attributes<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> sanitizedBody <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">sanitizedBody</span><span class="token operator">:</span> sanitizedBody<span class="token punctuation">}</span><span class="token punctuation">)</span>
  req<span class="token punctuation">.</span>sanitizedBody <span class="token operator">=</span> sanitizedBody
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sanitizeBody
</code></pre></div><p>This version should be functionally equivalent to what we had before. Test it with Postman to be sure that it is working.</p> <p>OK now we can augment the stripTags function to check for objects and then call itself to loop over that nested object and sanitize it's properties. Wrap the logic inside the for..in loop in an if/else block.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xss</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Test that with Postman ...</p> <p><img src="/w2023/assets/img/screenshot-postman-xss-test-object.7f133f65.png" alt="screenshot of Postman test"></p> <p>Great! Now let's make sure that we handle Arrays properly. Since arrays inherit from Object in JavaScript, we need to check for that case first. Then instead of just recursively calling stripTags on the array, we need to use the <code>.map()</code> method to loop over the array.</p> <p>Each element could be another complex object or a simple string. We need to check and handle both cases. If it is a string we can call <code>xss()</code> otherwise call <code>stripTags()</code> again.</p> <p>Rather than duplicate the code for the <code>xss()</code> function call, let's extract that to a separate function in our module.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> <span class="token function-variable function">sanitize</span> <span class="token operator">=</span> <span class="token parameter">sourceString</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">xss</span><span class="token punctuation">(</span>sourceString<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then the conditional block in the <code>stripTags()</code> function becomes ...</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>The return statement of the <code>map()</code> method above is using JavaScript's ternary operator, rather than a more verbose if/else block.</p></blockquote> <p>Writing out that single ternary expression the long way would look something like this ...</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> cleanedElement
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cleanedElement <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  cleanedElement <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> cleanedElement

</code></pre></div><p>OK. Test that with Postman ...</p> <p><img src="/w2023/assets/img/screenshot-postman-xss-test-array.e6a684b2.png" alt="screenshot of Postman test"></p> <p>Phew!</p> <p>The final version of the <code>sanitizeBody.js</code> middleware module should look similar to this (with no debug statements).</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">sanitize</span> <span class="token operator">=</span> <span class="token parameter">sourceString</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">xss</span><span class="token punctuation">(</span>sourceString<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">whiteList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTag</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stripIgnoreTagBody</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'script'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">stripTags</span> <span class="token operator">=</span> <span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> attributes <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>payload <span class="token punctuation">}</span> <span class="token comment">// don't mutate the source data</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">element</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">typeof</span> element <span class="token operator">===</span> <span class="token string">'string'</span>
          <span class="token operator">?</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token comment">// if true</span>
          <span class="token operator">:</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// if false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sanitize</span><span class="token punctuation">(</span>attributes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> attributes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">sanitizeBody</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> _id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> sanitizedBody <span class="token operator">=</span> <span class="token function">stripTags</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span>sanitizedBody <span class="token operator">=</span> sanitizedBody<span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> sanitizeBody<span class="token punctuation">;</span>
</code></pre></div><p>OK. Now we can be reasonably sure that all HTML tags and scripts will be removed from all req.body properties, no matter how deeply they are buried.</p> <h1 id="database-injection"><a href="#database-injection" class="header-anchor">#</a> Database Injection</h1> <p>Using Mongoose which enforces schema validation and attempts type coercion to ensure that only data in the correct format is stored, goes a long way to protecting MongoDB from various attacks. However, there are still some cases that are not covered.</p> <p><a href="https://nullsweep.com/a-nosql-injection-primer-with-mongo/" target="_blank" rel="noopener noreferrer">Read A NoSQL Injection Primer with Mongo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to learn more about this kind of vulnerability.</p> <p>To help protect against database injection attacks, we will use the <a href="https://www.npmjs.com/package/express-mongo-sanitize" target="_blank" rel="noopener noreferrer">Express Mongoose Sanitize<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM package.</p> <p>From the docs ...</p> <h3 id="what"><a href="#what" class="header-anchor">#</a> What?</h3> <p>This module searches for any keys in objects that begin with a $ sign or contain a ., from req.body, req.query or req.params. It can then either:</p> <p>completely remove these keys and associated data from the object, or
replace the prohibited characters with another allowed character.
The behaviour is governed by the passed option, replaceWith. Set this option to have the sanitizer replace the prohibited characters with the character passed in.</p> <h3 id="why"><a href="#why" class="header-anchor">#</a> Why?</h3> <p>Object keys starting with a <code>$</code> or containing a <code>.</code> are reserved for use by MongoDB as operators. Without this sanitization, malicious users could send an object containing a <code>$</code> operator, or including a <code>.</code>, which could change the context of a database operation. Most notorious is the <code>$where</code> operator, which can execute arbitrary JavaScript on the database.</p> <p>The best way to prevent this is to sanitize the received data, and remove any offending keys, or replace the characters with a 'safe' one.</p> <h4 id="let-s-install-it"><a href="#let-s-install-it" class="header-anchor">#</a> Let's install it</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>yarn add express<span class="token operator">-</span>mongo<span class="token operator">-</span>sanitize
</code></pre></div><h4 id="let-s-implement-it"><a href="#let-s-implement-it" class="header-anchor">#</a> Let's implement it</h4> <p>We could implement this middleware on a route by route basis. e.g.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// At the route level</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Or at the router level ...</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> <span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> carsRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Or at the application level ...</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Let's choose the application level -- set it and forget it!</p> <p>Don't forget</p> <p>You need to require the module before you can use it.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> sanitizeMongo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-mongo-sanitize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="logging"><a href="#logging" class="header-anchor">#</a> Logging</h2> <p>In production applications, it is a good practice to use a logger like <a href="https://www.npmjs.com/package/winston" target="_blank" rel="noopener noreferrer">Winston<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> instead of writing debug or console.log statements. Instead of just writing debug statements to the console, a logger can also write them out to a file or database table that can be analysed later.</p> <p>A logger lets you tag your output with a <a href="https://www.npmjs.com/package/winston#logging-levels" target="_blank" rel="noopener noreferrer">severity level<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. This makes it easier to filter for right level of detail.</p> <h3 id="winston"><a href="#winston" class="header-anchor">#</a> Winston</h3> <p>Let's install and setup Winston.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> winston
</code></pre></div><p>Now define a new <code>logger.js</code> module in the <code>/util</code> folder.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/util/logger</span>
<span class="token string">'use strict'</span>

<span class="token keyword">const</span> winston <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'winston'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> winston<span class="token punctuation">.</span><span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">format</span><span class="token operator">:</span> winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">defaultMeta</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">service</span><span class="token operator">:</span> <span class="token string">'student-service'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">transports</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">//</span>
    <span class="token comment">// - Write to all logs with level `info` and below to `combined.log`</span>
    <span class="token comment">// - Write all logs error (and below) to `error.log`.</span>
    <span class="token comment">//</span>
    <span class="token keyword">new</span> <span class="token class-name">winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>File</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'error.log'</span><span class="token punctuation">,</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>File</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'combined.log'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//</span>
<span class="token comment">// If we're not in production then log to the `console` with the format:</span>
<span class="token comment">// `${info.level}: ${info.message} JSON.stringify({ ...rest }) `</span>
<span class="token comment">//</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>Console</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> winston<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> logger<span class="token punctuation">;</span>
</code></pre></div><p>Import this <code>logger</code> module in every other module and update any console.log or debug statements. For example in the <code>/startup/connectDatabase</code> module ...</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// src/util/db.js</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./logger'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mongoose
    <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGO_URL</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Connected to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Error connecting to MongoDB ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Winston is a very flexible logger with a lot of additional capabilities. Be sure to <a href="https://www.npmjs.com/package/winston" target="_blank" rel="noopener noreferrer">read the full documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to know what it can do.</p> <h3 id="node-env"><a href="#node-env" class="header-anchor">#</a> NODE_ENV</h3> <p>Like in the Winston configuration above, it is very common to have conditional logic in the main app startup module(s) that set different behaviours based on the deployment environment. For example, we generally want to see debugging or detailed logging during development, but want to suppress these in production.</p> <p>As you know we can access command shell environment variables using the <code>process.env</code> object. It is a common best practice to set the <code>NODE_ENV</code> environment variable to indicate the current runtime environment. Some typical values are: <code>dev</code>, <code>development</code>, <code>test</code>, <code>staging</code>, <code>prod</code>, <code>production</code>.</p> <p>If <code>NODE_ENV</code> is not set, <code>process.env.NODE_ENV</code> returns <code>undefined</code>.</p> <p>Because this is such a common use case, Express provides another way to read the <code>NODE_ENV</code> environment variable – using <code>app.get('env')</code>. If <code>NODE_ENV</code> is not set, <code>app.get('env')</code> returns <code>development</code> as a default value.</p> <p>To declare the production environment run this command in the terminal.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production
</code></pre></div><p>To set it back to development simply reset the value of the <code>NODE_ENV</code> variable.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development
</code></pre></div> <h3 id="generate-jwt-secret"><a href="#generate-jwt-secret" class="header-anchor">#</a> Generate JWT Secret</h3> <p>The JWT secret key can be any string value. To make it more effective, it should be at least 30 characters and preferably random. Here is a simple script to generate a new random key. Create a new top level file called <code>genKey.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>When you are setting up your deployment environment, run the script and then copy the output to set the environment variable.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">node</span> genKey.js
ixzz7ph7goovu62b6hz3k6egyghhbn

<span class="token builtin class-name">export</span> <span class="token assign-left variable">APP_JWTKEY</span><span class="token operator">=</span>ixzz7ph7goovu62b6hz3k6egyghhbn
</code></pre></div><div class="custom-block danger"><p class="custom-block-title">DANGER</p> <p>The JWT secret key should only be changed if there is a suspected security breach. Changing it will immediately invalidate all exiting tokens.</p></div> <h2 id="compression"><a href="#compression" class="header-anchor">#</a> Compression</h2> <p>To improve network communications performance, we look for any opportunity to reduce the payload size for any given request/response cycle. One such possibility is to use standard text compression algorithms on the response payload.</p> <p>The NPM module called <a href="https://github.com/expressjs/compression" target="_blank" rel="noopener noreferrer">compression<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a Node.js compression middleware. It will attempt to compress the <code>response.body</code> using gzip for responses with a compatible <code>Content-Type</code> header value (e.g. text/html or application/json). See the <a href="https://www.npmjs.com/package/compressible" target="_blank" rel="noopener noreferrer">compressible<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> module for default behaviour.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> compression
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> compression <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'compression'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// attempt to compress all routes</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">compression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="security-middleware"><a href="#security-middleware" class="header-anchor">#</a> Security Middleware</h2> <p>As we have discussed before, good application security is not &quot;a feature&quot; and not &quot;a bolt-on module&quot;. It is about applying multi-layered best practices throughout the design and development cycle. As we prepare to deploy our web service to a production environment, <a href="https://www.npmjs.com/package/cors" target="_blank" rel="noopener noreferrer">CORS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.npmjs.com/package/helmet" target="_blank" rel="noopener noreferrer">Helmet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are two important middleware modules that help.</p> <h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>Read this <em>HTML5 Rocks</em> backgrounder on <a href="https://www.html5rocks.com/en/tutorials/cors/" target="_blank" rel="noopener noreferrer">Cross-Origin Resource Sharing (CORS)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <blockquote><p>The use-case for CORS is simple. Imagine the site alice.com has some data that the site bob.com wants to access. This type of request traditionally wouldn’t be allowed under the browser’s same origin policy. However, by supporting CORS requests, alice.com can add a few special response headers that allows bob.com to access the data.</p></blockquote> <p>To manage CORS in our Express web service use the <a href="https://www.npmjs.com/package/cors" target="_blank" rel="noopener noreferrer">cors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> package from NPM.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> cors
</code></pre></div><p>Then require it in the main <code>app.js</code> module and apply it as the first middleware with the default settings.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// other middleware goes here</span>
</code></pre></div><p>The <code>cors()</code> middleware constructor function takes an optional <a href="https://www.npmjs.com/package/cors#configuration-options" target="_blank" rel="noopener noreferrer">configuration options<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object. The default settings are equivalent to setting the options object with these values.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;origin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;methods&quot;</span><span class="token operator">:</span> <span class="token string">&quot;GET,HEAD,PUT,PATCH,POST,DELETE&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;preflightContinue&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;optionsSuccessStatus&quot;</span><span class="token operator">:</span> <span class="token number">204</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This will let a client app served from <em>any</em> domain name access the API resources.</p> <h3 id="helmet"><a href="#helmet" class="header-anchor">#</a> Helmet</h3> <p>The <a href="https://www.npmjs.com/package/helmet" target="_blank" rel="noopener noreferrer">helmet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> NPM module is an integrated middleware package (with 14 sub-modules) that implements many network communications <strong>security best practices</strong>.</p> <blockquote><p>It's not a silver bullet, but it can help!</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> helmet
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> helmet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'helmet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Not all of the included middleware functions are enabled by default. See the <a href="https://helmetjs.github.io/docs/" target="_blank" rel="noopener noreferrer">full documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for all of the options and details about the kinds of attacks they help to prevent.</p> <h2 id="npm-audit"><a href="#npm-audit" class="header-anchor">#</a> NPM audit</h2> <p>The NPM package manager has a built-in function to scan the entire dependency tree for known security vulnerabilities. This will output a list of packages that may need to be updated or replaced with a more secure library module. It is a good idea to run this check regularly, as new attack vectors are discovered and reported on an ongoing basis.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> audit
</code></pre></div><h2 id="assignment"><a href="#assignment" class="header-anchor">#</a> Assignment</h2> <p><a href="/w2023/deliverables/assignment3.html">Assignment 3 - Pokemon API with Authentication</a> - is due <strong>before</strong> next week's class.</p> <h2 id="more-readings"><a href="#more-readings" class="header-anchor">#</a> More readings</h2> <ul><li><a href="https://web.dev/csp/" target="_blank" rel="noopener noreferrer">An Introduction to Content Security Policy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://codeburst.io/learn-and-understand-recursion-in-javascript-b588218e87ea?gi=b23a029a1b4c" target="_blank" rel="noopener noreferrer">Learn and Understand Recursion in JavaScript<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/" target="_blank" rel="noopener noreferrer">ES modules: A cartoon deep-dive<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/29/2023, 9:11:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2023/modules/week11/" class="prev">
        Week 11: Authentication With Passport
      </a></span> <span class="next"><a href="/w2023/modules/week13/">
        Week 13: Testing with Jest
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/w2023/assets/js/app.a268f35f.js" defer></script><script src="/w2023/assets/js/3.30d56026.js" defer></script><script src="/w2023/assets/js/12.7642e84c.js" defer></script><script src="/w2023/assets/js/16.1e8637e4.js" defer></script>
  </body>
</html>
