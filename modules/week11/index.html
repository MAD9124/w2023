<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 11: Authentication With Passport | MAD9124</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Full-stack: API Development">
    
    <link rel="preload" href="/w2023/assets/css/0.styles.9d277d19.css" as="style"><link rel="preload" href="/w2023/assets/js/app.a268f35f.js" as="script"><link rel="preload" href="/w2023/assets/js/3.30d56026.js" as="script"><link rel="preload" href="/w2023/assets/js/6.fec5c1cc.js" as="script"><link rel="preload" href="/w2023/assets/js/16.1e8637e4.js" as="script"><link rel="prefetch" href="/w2023/assets/js/10.b7c1a16d.js"><link rel="prefetch" href="/w2023/assets/js/11.f2aecf7a.js"><link rel="prefetch" href="/w2023/assets/js/12.7642e84c.js"><link rel="prefetch" href="/w2023/assets/js/13.5e27a08c.js"><link rel="prefetch" href="/w2023/assets/js/14.4b92b91c.js"><link rel="prefetch" href="/w2023/assets/js/15.628eb87b.js"><link rel="prefetch" href="/w2023/assets/js/17.feedfd9c.js"><link rel="prefetch" href="/w2023/assets/js/18.4d23c18f.js"><link rel="prefetch" href="/w2023/assets/js/19.bdc3f6f0.js"><link rel="prefetch" href="/w2023/assets/js/2.c49fd8f9.js"><link rel="prefetch" href="/w2023/assets/js/20.7bb0ba89.js"><link rel="prefetch" href="/w2023/assets/js/21.bbf158ab.js"><link rel="prefetch" href="/w2023/assets/js/22.04ba04d6.js"><link rel="prefetch" href="/w2023/assets/js/23.b3f8222f.js"><link rel="prefetch" href="/w2023/assets/js/24.74d3f93b.js"><link rel="prefetch" href="/w2023/assets/js/25.5343cc2e.js"><link rel="prefetch" href="/w2023/assets/js/26.9f73a8bf.js"><link rel="prefetch" href="/w2023/assets/js/27.45bceba5.js"><link rel="prefetch" href="/w2023/assets/js/28.3f49100e.js"><link rel="prefetch" href="/w2023/assets/js/29.dff6b604.js"><link rel="prefetch" href="/w2023/assets/js/30.0d01a8e4.js"><link rel="prefetch" href="/w2023/assets/js/31.cfbc8e9f.js"><link rel="prefetch" href="/w2023/assets/js/32.2bd8381f.js"><link rel="prefetch" href="/w2023/assets/js/33.c0fa7e80.js"><link rel="prefetch" href="/w2023/assets/js/34.a29cefed.js"><link rel="prefetch" href="/w2023/assets/js/35.26354f67.js"><link rel="prefetch" href="/w2023/assets/js/36.5d697666.js"><link rel="prefetch" href="/w2023/assets/js/37.19db9f95.js"><link rel="prefetch" href="/w2023/assets/js/38.388e9638.js"><link rel="prefetch" href="/w2023/assets/js/39.aa1380a5.js"><link rel="prefetch" href="/w2023/assets/js/4.c0130289.js"><link rel="prefetch" href="/w2023/assets/js/40.1e348976.js"><link rel="prefetch" href="/w2023/assets/js/5.9d721531.js"><link rel="prefetch" href="/w2023/assets/js/7.054fdd44.js"><link rel="prefetch" href="/w2023/assets/js/8.5b458cb5.js"><link rel="prefetch" href="/w2023/assets/js/9.2198ac92.js">
    <link rel="stylesheet" href="/w2023/assets/css/0.styles.9d277d19.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/w2023/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/w2023/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/w2023/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/w2023/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/w2023/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/w2023/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/w2023/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/w2023/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/w2023/modules/week3/" class="sidebar-link">Week 3: APIs</a></li><li><a href="/w2023/modules/week4/" class="sidebar-link">Week 4: Building RESTful APIs with Express</a></li><li><a href="/w2023/modules/week5/" class="sidebar-link">Week 5: Asynchronous Programming</a></li><li><a href="/w2023/modules/week6/" class="sidebar-link">Week 6: Middleware</a></li><li><a href="/w2023/modules/week7/" class="sidebar-link">Week 7: Midterm Project</a></li><li><a href="/w2023/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/w2023/modules/week9/" class="sidebar-link">Week 9: Data Persitance and MongoDB</a></li><li><a href="/w2023/modules/week10/" class="sidebar-link">Week 10: Object Data Modelling with Mongoose</a></li><li><a href="/w2023/modules/week11/" aria-current="page" class="active sidebar-link">Week 11: Authentication With Passport</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#ama-review" class="sidebar-link">AMA / Review</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#what-is-passport" class="sidebar-link">What is Passport?</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#create-a-google-application" class="sidebar-link">Create a Google Application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#creating-your-google-account" class="sidebar-link">Creating your Google Account</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#creating-your-first-project" class="sidebar-link">Creating your first project</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#setting-up-the-oauth-consent-screen" class="sidebar-link">Setting up the OAuth Consent Screen</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#creating-our-shared-credentials" class="sidebar-link">Creating our shared credentials</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#we-are-all-set-with-google" class="sidebar-link">We are all set with Google!</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#setting-up-passport-application" class="sidebar-link">Setting up Passport Application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#install-the-dependencies" class="sidebar-link">Install the dependencies</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#set-up-our-index-js-file" class="sidebar-link">Set up our index.js file</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#create-the-user-model" class="sidebar-link">Create the User Model</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#configure-the-strategy" class="sidebar-link">Configure the strategy</a></li></ul></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#sessions" class="sidebar-link">Sessions</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#locking-down-routes-with-middleware" class="sidebar-link">Locking down routes with middleware</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#persisting-our-session" class="sidebar-link">Persisting our Session</a></li><li class="sidebar-sub-header"><a href="/w2023/modules/week11/#testing-in-postman" class="sidebar-link">Testing in Postman</a></li></ul></li><li><a href="/w2023/modules/week12/" class="sidebar-link">Week 12: Data Santization, XSS and LoggingS</a></li><li><a href="/w2023/modules/week13/" class="sidebar-link">Week 13: Testing with Jest</a></li><li><a href="/w2023/modules/week14/" class="sidebar-link">Week 14: Preparing for Production</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 11</span><br> <span class="title">Authentication With Passport</span></h1> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 mins)</li> <li>What is Passport</li> <li>Create a Google Application</li> <li>Setting up Passport Application</li> <li>Sessions</li> <li>Locking Down Routes</li> <li>Persisting our Session</li> <li>Testing in Postman</li></ul> <h2 id="ama-review"><a href="#ama-review" class="header-anchor">#</a> AMA / Review</h2> <h2 id="what-is-passport"><a href="#what-is-passport" class="header-anchor">#</a> What is Passport?</h2> <p>Passport is authentication middleware for Node.js. Extremely flexible and modular, Passport can be unobtrusively dropped in to any Express-based web application. A comprehensive set of strategies support authentication using a username and password, Google, Facebook, Twitter, and more. Check out their website <a href="https://www.passportjs.org/" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. We will be using <a href="https://www.passportjs.org/packages/passport-google-oauth20/" target="_blank" rel="noopener noreferrer">passport-google-oauth2.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="create-a-google-application"><a href="#create-a-google-application" class="header-anchor">#</a> Create a Google Application</h2> <h3 id="creating-your-google-account"><a href="#creating-your-google-account" class="header-anchor">#</a> Creating your Google Account</h3> <p>Before we can use passport to login via Google, we will need to create a Google application, and generate keys that we will share with Google, so they know who we are.</p> <p>Begin the process by going to <a href="https://console.developers.google.com/" target="_blank" rel="noopener noreferrer">Google Developers Console<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and creating a google account with your algonquincollege email.
<img src="/w2023/assets/img/google_sign_in.5c9053a6.png" alt="Sign In"></p> <p>You will need to provide your phone number for 2FA, as well as a few other details.</p> <p><img src="/w2023/assets/img/google_sign_up.28d49f6c.png" alt="Sign Up"></p> <p>Once you are signed up and signed in, you should be able to get to this <a href="https://console.cloud.google.com/projectselector2/apis/dashboard" target="_blank" rel="noopener noreferrer">page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <p><img src="/w2023/assets/img/APIs_and_services.0b20fa07.png" alt="API page"></p> <hr> <h3 id="creating-your-first-project"><a href="#creating-your-first-project" class="header-anchor">#</a> Creating your first project</h3> <p>Now we need to create a project.</p> <ul><li>click on the <code>Select a project</code> dropdown at the top left of the page.
<img src="/w2023/assets/img/create_project.1e3e6212.png" alt="Create project"></li> <li>name your project using your student number and week11
<img src="/w2023/assets/img/create_project_form.498aa5c9.png" alt="Create project form"></li></ul> <h3 id="setting-up-the-oauth-consent-screen"><a href="#setting-up-the-oauth-consent-screen" class="header-anchor">#</a> Setting up the OAuth Consent Screen</h3> <ul><li>Navigate to APIs &amp; Services / Oauth consent screen</li> <li>Select User Type External and click CREATE
<img src="/w2023/assets/img/google_oauth_consent01.d7f513e8.png" alt="Oauth Consent Screen"></li> <li>Fill out the form with App name, User support email (your algonquin email), and Developer contact email (also you algonquin email)</li></ul> <p><em>The rest of the information can be skipped for now, but should be filled out in a non testing environment</em></p> <ul><li>Add the scope <code>./auth/userinfo.profile</code>, we will get the user's name and email from google.</li></ul> <p><em>We will not be needing any sensitive scopes for this project</em></p> <ul><li>Add test users. Only users on the list will be able to sign in to your app. Please add yourself and me <code>robillt@algonquincollege.com</code> so I can sign in to your app!
<img src="/w2023/assets/img/google_oauth_add_user.cd37d846.png" alt="Oauth Consent Screen Users"></li> <li>Fill out the form with App name, User support email (your algonquin email), and Developer contact email (also you algonquin email)</li> <li>Review all of your entries, and hit back to dashboard if it is all good.</li></ul> <h3 id="creating-our-shared-credentials"><a href="#creating-our-shared-credentials" class="header-anchor">#</a> Creating our shared credentials</h3> <p>Google will need a way to connect requests coming from our node application to the application we are setting up in Google. We can do this using generated credentials.</p> <p><img src="/w2023/assets/img/google_credentials01.70df21e3.png" alt="Google Credntials dashboard"></p> <ul><li>Navigate to APIs &amp; Services / Credentials</li> <li>Click Create Credentials, OAuth client ID</li> <li>Fill out the form with Application type: <code>Web application</code>, name whatever you like, and add <code>http://localhost:3000</code> as the authorized JavaScript origin, and <code>http://localhost:3001/auth/google/callback</code> as the Authorized redirect URI</li></ul> <p><em>NOTE - You will have to tell google your production domains when you are ready to deploy. ex <code>https://example.ca</code></em></p> <ul><li>Once it is done you should see the following modal. Copy the client ID and Client Secret, and add it to your .env file
<img src="/w2023/assets/img/google_credentials_success.677594d6.png" alt="Google Success"> <img src="data:image/png;base64,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" alt="env"></li></ul> <p><em>It is important to keep these safe. DO NOT COMMIT THEM TO GITHUB.
I have deleted the credentials in the picture</em></p> <h3 id="we-are-all-set-with-google"><a href="#we-are-all-set-with-google" class="header-anchor">#</a> We are all set with Google!</h3> <hr> <h2 id="setting-up-passport-application"><a href="#setting-up-passport-application" class="header-anchor">#</a> Setting up Passport Application</h2> <h3 id="install-the-dependencies"><a href="#install-the-dependencies" class="header-anchor">#</a> Install the dependencies</h3> <p>We will need to install our usual depencies, plus 3 new dependencies:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> express mongoose morgan passport passport-google-oauth2 express-session
</code></pre></div><p><em>NOTE more on express-session later</em></p> <h3 id="set-up-our-index-js-file"><a href="#set-up-our-index-js-file" class="header-anchor">#</a> Set up our index.js file</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv/config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello, world!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3001</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="create-the-user-model"><a href="#create-the-user-model" class="header-anchor">#</a> Create the User Model</h3> <p>In <code>src/models/User.js</code>, define the User schema and model. We will be getting the name and googleId from google.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> model<span class="token punctuation">,</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">googleId</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UserSchema<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'toObject'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_doc<span class="token punctuation">,</span> ret</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>ret<span class="token punctuation">,</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> ret<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="configure-the-strategy"><a href="#configure-the-strategy" class="header-anchor">#</a> Configure the strategy</h3> <p>We will configure passport in its own file to keep it neat.</p> <p>Begin by importing the required libraries and User Model</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// util/passport.js</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> GoogleStrategy <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport-google-oauth20&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">GOOGLE_CLIENT_ID</span><span class="token punctuation">,</span> <span class="token constant">GOOGLE_CLIENT_SECRET</span><span class="token punctuation">,</span> <span class="token constant">GOOGLE_CALLBACK_URL</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>
</code></pre></div><p>Next, we tell passport to use the the GoogleStrategy, and configure it with our ids and urls.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>passport<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">GoogleStrategy</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Dont forget to import from process.env</span>
      <span class="token literal-property property">clientID</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CLIENT_ID</span><span class="token punctuation">,</span>
      <span class="token literal-property property">clientSecret</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CLIENT_SECRET</span><span class="token punctuation">,</span>
      <span class="token literal-property property">callbackURL</span><span class="token operator">:</span> <span class="token constant">GOOGLE_CALLBACK_URL</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">_accessToken<span class="token punctuation">,</span> _refreshToken<span class="token punctuation">,</span> profile<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// here, we will look up a user by the googleId, and either</span>
        <span class="token comment">// create a new User if none exists, or</span>
        <span class="token comment">// update the existing User, in case they changed their name in google.</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span> <span class="token literal-property property">googleId</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">$set</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>displayName<span class="token punctuation">,</span>
              <span class="token literal-property property">googleId</span><span class="token operator">:</span> profile<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment">// upsert is how we tell mongoose to UP-date the document or in-SERT a new one</span>
          <span class="token comment">// don't forget to tell mongoose to return the updated document!</span>
          <span class="token punctuation">{</span> <span class="token literal-property property">upsert</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">returnDocument</span><span class="token operator">:</span> <span class="token string">'after'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally, passport needs to know how to serialize and deserialize the User.</p> <ul><li>Serializing the User takes it from its expanded state, and stores it how we want it in the session. The safest way to do this is by saving just the id.</li> <li>Deserializing is the opposite, and will take the serialized version (in our case the id) and transform it back into the full User object.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>passport<span class="token punctuation">.</span><span class="token function">serializeUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

passport<span class="token punctuation">.</span><span class="token function">deserializeUser</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">done</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we will create our authentication routes. One will be the route to redirect to google, asking to login. The next is the route google will send its response to with either a success or an error depending on what happens with google.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// router/auth.js</span>
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> Router <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> passport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> authRouter <span class="token operator">=</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make sure to import the configuration we set up above</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../util/passport&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// this route will redirect the user to google</span>
authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// this route will be hit by google once they are finished.</span>
authRouter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">&quot;/google/callback&quot;</span><span class="token punctuation">,</span>
  passport<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token string">&quot;google&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">failureRedirect</span><span class="token operator">:</span> <span class="token string">&quot;/login&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> authRouter<span class="token punctuation">;</span>
</code></pre></div><h2 id="sessions"><a href="#sessions" class="header-anchor">#</a> Sessions</h2> <p>Because HTTP requests are stateless, we need a way to keep track of data between requests. Cookies and URL parameters are one way, but what about for data you don't want the client to know about?  This is where sessions come in. We store the data on the server with an id, and let the client only know the id for the session. We can then look it up again on the server and access the data.</p> <p>Passport uses sessions to keep tracked of whether or not we have been signed in with google.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/index.js</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">secret</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SESSION_SECRET</span><span class="token punctuation">,</span>
    <span class="token literal-property property">resave</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">saveUninitialized</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we can initialize passport, and connect it to the session we set up.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>passport<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>With everything set up correctly, passport will check the session on every request, and attach a user to the request if their is a successful login saved in the session.</p> <p>We can test this out with a simple middleware.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> _res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Note that it should log out user undefined initially. Once we go to /auth/google and sign in with google, we should see a user object logged out. We are in!</p> <h2 id="locking-down-routes-with-middleware"><a href="#locking-down-routes-with-middleware" class="header-anchor">#</a> Locking down routes with middleware</h2> <p>We now know that any request from a logged in user will have a user object attached to the request. We can leverage this to create a super simple middleware function call <code>isAuthenticated</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/middleware/isAuthenticated.js</span>
<span class="token string">'use strict'</span>

<span class="token keyword">const</span> <span class="token function-variable function">isAuthenticated</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'You must be signed in to access this'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// NOTE if your error handler is set up, you can throw an UnAuthenticatedError here instead</span>
    <span class="token comment">// throw new UnAuthenticatedError('You must be signed in to access this');</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> isAuthenticated
</code></pre></div><p>Let's create a second route that you must be authenticated to see.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/private'</span><span class="token punctuation">,</span> isAuthenticated<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'You are logged in!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="persisting-our-session"><a href="#persisting-our-session" class="header-anchor">#</a> Persisting our Session</h2> <p>You may notice, and be quite frustrated, that every time our server restarts, we lose our session, and need to log in again. This is because the default session is stored in memory (just like we stored our student data in arrays).</p> <p>The most popular way to save a session is using Redis, a quick and lightway database, but we will use <code>connect-mongo</code> to save learning a whole new DB.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/index.js</span>

<span class="token comment">// update our session object to look like this</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">store</span><span class="token operator">:</span> MongoStore<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">mongoUrl</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGO_URL</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">secret</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SESSION_SECRET</span><span class="token punctuation">,</span>
    <span class="token literal-property property">resave</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">saveUninitialized</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Thats it! Our session will now be stored in mongo, and will persist even after refreshing our server!</p> <h2 id="testing-in-postman"><a href="#testing-in-postman" class="header-anchor">#</a> Testing in Postman</h2> <p>How can we access private routes in postman? We can copy the session id from the browser, and add it to the headers in Postman.</p> <p>After successfully logging in to our app in the browser, open up the developer tools and go to the Application tab. You should see our session under Cookies, with the default id <code>connect.sid</code>.</p> <p><img src="/w2023/assets/img/dev_tools.f174a904.png" alt="developer tools"></p> <p>We can copy this session id, and add it to our headers in Postman. And just like that, we are now signed in!</p> <p><img src="/w2023/assets/img/postman_headers.a4731e49.png" alt="Postman Headers"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/19/2023, 10:37:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/w2023/modules/week10/" class="prev">
        Week 10: Object Data Modelling with Mongoose
      </a></span> <span class="next"><a href="/w2023/modules/week12/">
        Week 12: Data Santization, XSS and LoggingS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/w2023/assets/js/app.a268f35f.js" defer></script><script src="/w2023/assets/js/3.30d56026.js" defer></script><script src="/w2023/assets/js/6.fec5c1cc.js" defer></script><script src="/w2023/assets/js/16.1e8637e4.js" defer></script>
  </body>
</html>
