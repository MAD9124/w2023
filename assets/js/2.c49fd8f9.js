(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{239:function(t,s,e){t.exports=e.p+"assets/img/aws-classroom-setup12.b0856cfe.png"},240:function(t,s,e){t.exports=e.p+"assets/img/aws-classroom-setup15.5f332920.png"},241:function(t,s,e){t.exports=e.p+"assets/img/aws-classroom-setup16.df90114d.png"},256:function(t,s,e){t.exports=e.p+"assets/img/mongo-connect-options.ac4d4be9.png"},311:function(t,s,e){t.exports=e.p+"assets/img/mongo-homepage.ab3e76a9.png"},312:function(t,s,e){t.exports=e.p+"assets/img/mongo-atlas-create-account.30dfcda3.png"},313:function(t,s,e){t.exports=e.p+"assets/img/mongo-atlas-confirmation-email.75dd2831.png"},314:function(t,s,e){t.exports=e.p+"assets/img/mongo-atlas-login.e8772dae.png"},315:function(t,s,e){t.exports=e.p+"assets/img/mongo-create-cluster.70967fa3.png"},316:function(t,s,e){t.exports=e.p+"assets/img/mongo-shared-clusters.7eddf090.png"},317:function(t,s,e){t.exports=e.p+"assets/img/mongo-cluster-provider.7c414a5b.png"},318:function(t,s,e){t.exports=e.p+"assets/img/mongo-cluster-size.6d814b8e.png"},319:function(t,s,e){t.exports=e.p+"assets/img/mongo-cluster-name.ead36e99.png"},320:function(t,s,e){t.exports=e.p+"assets/img/mongo-cluster-dashboard.48fa593c.png"},321:function(t,s,e){t.exports=e.p+"assets/img/mongo-whitelist-ips.4e635c11.png"},322:function(t,s,e){t.exports=e.p+"assets/img/mongo-create-user.08dd85da.png"},323:function(t,s,e){t.exports=e.p+"assets/img/mongo-choose-connection-method.d6cf4669.png"},324:function(t,s,e){t.exports=e.p+"assets/img/mongo-connect-string.a0fac0d2.png"},325:function(t,s,e){t.exports=e.p+"assets/img/mongo-connect-string2.93e1fbd7.png"},326:function(t,s,e){t.exports=e.p+"assets/img/aws-classroom.b70bbfb5.png"},327:function(t,s,e){t.exports=e.p+"assets/img/aws-search-ecs.20ef23ea.png"},328:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-get-started.fa2e3e9e.png"},329:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-hierarchy.91fe84ad.png"},330:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-1.79b41a40.png"},331:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-2.a4ff4b2b.png"},332:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-3.888078f3.png"},333:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-4.cb2abec9.png"},334:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-5.3608d763.png"},335:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-6.cbffc288.png"},336:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-7.3432c22e.png"},337:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-8.43a4ceb7.png"},338:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-9.0c908c6a.png"},339:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-10.f45b13e1.png"},340:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-11.4062f7f9.png"},341:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-wizard-12.453f5272.png"},342:function(t,s,e){t.exports=e.p+"assets/img/aws-ecs-service-details.eb153dc7.png"},343:function(t,s,e){t.exports=e.p+"assets/img/aws-navigate-ec2.8fac0c20.png"},344:function(t,s,e){t.exports=e.p+"assets/img/aws-ec2-dashboard.7d29c3d2.png"},345:function(t,s,e){t.exports=e.p+"assets/img/aws-load-balancer-details.a2d5cc62.png"},422:function(t,s,e){"use strict";e.r(s);var a=e(14),n=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("WeekHeader",{attrs:{number:13,title:"Production Deployment"}}),t._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[t._v("Quiz 9: Production Prep "),s("Badge",{attrs:{text:"15 mins"}})],1),t._v(" "),s("p",[t._v("There will be a quiz today. It will be worth 2% of your final grade.")])]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("Assignment Reminder")]),t._v(" "),s("p",[s("RouterLink",{attrs:{to:"/deliverables/final.html"}},[t._v("Final project - GIFTR")]),t._v(" is due by "),s("strong",[t._v("5:00 pm April 17, 2020")]),t._v("."),s("br"),t._v("\nThis is the final deadline. There will be no extensions.")],1),t._v(" "),s("p",[t._v("Counts for 30% of your MAD9124 final grade.")])]),t._v(" "),s("h2",{attrs:{id:"architecture"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#architecture"}},[t._v("#")]),t._v(" Architecture")]),t._v(" "),s("p",[t._v("Of all cloud infrastructure service providers, Amazon Web Services (AWS) is far and away the market leader. We will take advantage of their generous education credits to learn how to deploy the final project using a typical architectural pattern.")]),t._v(" "),s("p",[t._v("Our main web service API application will be bundled into a Docker container which can be auto-scaled with service demand. This service container cluster will be accessed via an HTTP/HTTPS load-balancer, which can also manage the secure HTTPS connection with the client application. The Express containers will talk to the MongoDB service running in a high-availability cluster.")]),t._v(" "),s("p",[t._v("Additionally, your client application from MAD9022 could be served from a global content delivery network.")]),t._v(" "),s("p",[t._v("The key service components that we will need include:")]),t._v(" "),s("p",[s("strong",[t._v("Backend Web Service")])]),t._v(" "),s("ul",[s("li",[t._v("Docker Hub (image repository)")]),t._v(" "),s("li",[t._v("Amazon Virtual Private Cloud (VPC)")]),t._v(" "),s("li",[s("strike",[t._v("AWS Certificate Manager")])],1),t._v(" "),s("li",[t._v("Amazon HTTP/HTTP Application Load Balancer (ELB)")]),t._v(" "),s("li",[t._v("Amazon Elastic Container Service (ECS) with Fargate")]),t._v(" "),s("li",[t._v("MongoDB Atlas (deployed to a managed Amazon EC2 Cluster)")])]),t._v(" "),s("p",[s("strong",[t._v("Frontend Client APP")])]),t._v(" "),s("ul",[s("li",[s("strike",[t._v("Amazon Simple Storage Service (S3)")])],1),t._v(" "),s("li",[s("strike",[t._v("Amazon CloudFront (CDN)")])],1),t._v(" "),s("li",[t._v("GitHub PWA Private Repo")])]),t._v(" "),s("h2",{attrs:{id:"setup-hosted-mongodb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#setup-hosted-mongodb"}},[t._v("#")]),t._v(" Setup Hosted MongoDB")]),t._v(" "),s("p",[t._v("We will use the free tier of the "),s("a",{attrs:{href:"https://www.mongodb.com/cloud/atlas",target:"_blank",rel:"noopener noreferrer"}},[t._v("MongoDB Atlas"),s("OutboundLink")],1),t._v(" service to deploy a managed MongoDB instance to the same AWS region as our production Express server containers.")]),t._v(" "),s("h3",{attrs:{id:"create-a-mongodb-cloud-account"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-a-mongodb-cloud-account"}},[t._v("#")]),t._v(" Create a MongoDB cloud account")]),t._v(" "),s("p",[t._v("From the "),s("a",{attrs:{href:"https://www.mongodb.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("MongoDB home page"),s("OutboundLink")],1),t._v(", click the green "),s("code",[t._v("Start Free")]),t._v(" button.\n"),s("img",{attrs:{src:e(311),alt:"MongoDB home page"}})]),t._v(" "),s("p",[t._v("Fill in the form to create your free account. "),s("strong",[t._v("Please use your Algonquin College email address")]),t._v(".\n"),s("img",{attrs:{src:e(312),alt:"Atlas sign-up form"}})]),t._v(" "),s("p",[t._v("You should shortly receive a confirmation email from MongoDB Atlas. Click the "),s("code",[t._v("Sign In")]),t._v(" button in that email.\n"),s("img",{attrs:{src:e(313),alt:"Confirmation email"}})]),t._v(" "),s("p",[t._v("That will take you to the "),s("a",{attrs:{href:"https://account.mongodb.com/account/login",target:"_blank",rel:"noopener noreferrer"}},[t._v("MongoDB Atlas login page"),s("OutboundLink")],1),t._v(".\n"),s("img",{attrs:{src:e(314),alt:"MongoDB Atlas Login"}})]),t._v(" "),s("h3",{attrs:{id:"create-database-cluster"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-database-cluster"}},[t._v("#")]),t._v(" Create Database Cluster")]),t._v(" "),s("p",[t._v("Follow the prompts to create your first Project and Cluster.")]),t._v(" "),s("p",[s("img",{attrs:{src:e(315),alt:"create cluster"}})]),t._v(" "),s("p",[t._v("Choose the "),s("strong",[t._v("Shared Clusters")]),t._v(" option -- the free one.\n"),s("img",{attrs:{src:e(316),alt:"shared clusters"}})]),t._v(" "),s("h4",{attrs:{id:"configure-cluster"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-cluster"}},[t._v("#")]),t._v(" Configure Cluster")]),t._v(" "),s("p",[t._v("Choose "),s("strong",[t._v("AWS")]),t._v(" as the cloud provider. "),s("strong",[t._v("DO NOT")]),t._v(" choose 'Multi-Region ...'")]),t._v(" "),s("p",[t._v("Choose the "),s("strong",[t._v("N. Virginia")]),t._v(" AWS Region.\n"),s("img",{attrs:{src:e(317),alt:"cluster configuration - AWS region"}})]),t._v(" "),s("p",[t._v("Under the heading "),s("strong",[t._v("Cluster Tier")]),t._v(", choose "),s("code",[t._v("M0 Sandbox")]),t._v(" -- this is the free one.\n"),s("img",{attrs:{src:e(318),alt:"cluster configuration - size"}})]),t._v(" "),s("p",[t._v("Do not select any "),s("strong",[t._v("Additional Settings")]),t._v(". They are not available in the free tier.")]),t._v(" "),s("p",[t._v("Set the "),s("strong",[t._v("Cluster Name")]),t._v(" to "),s("code",[t._v("GIFTR")]),t._v(".\n"),s("img",{attrs:{src:e(319),alt:"cluster configuration - name"}})]),t._v(" "),s("p",[t._v("Verify your settings and click the green "),s("code",[t._v("Create Cluster")]),t._v(" button.")]),t._v(" "),s("p",[t._v("You should now see the "),s("strong",[t._v("Clusters Dashboard")]),t._v(" while your new cluster is being provisioned. There should be a blue "),s("code",[t._v("sandbox")]),t._v(" label on your cluster -- this means the free tier.\n"),s("img",{attrs:{src:e(320),alt:"cluster configuration - name"}})]),t._v(" "),s("h4",{attrs:{id:"setup-connection-security"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#setup-connection-security"}},[t._v("#")]),t._v(" Setup Connection Security")]),t._v(" "),s("p",[t._v("There are still a few more steps. Click the "),s("code",[t._v("connect")]),t._v(" button under your cluster name to bring up an information modal.")]),t._v(" "),s("p",[t._v("We will be accessing this cluster from multiple locations – home, school, AWS. We could (and in a real app SHOULD) whitelist only those IP addresses that need to connect to the database. But, for this project we can simply allow all.\n"),s("img",{attrs:{src:e(321),alt:"cluster configuration - IP addresses"}})]),t._v(" "),s("p",[t._v("Click the "),s("code",[t._v("Add a Different IP Address")]),t._v(" button, and then enter "),s("code",[t._v("0.0.0.0/0")]),t._v(" for the IP address (CDIR notation) and click "),s("code",[t._v("Add IP Address")]),t._v(".")]),t._v(" "),s("p",[t._v("Next you will be asked to create an new administrative user for your database cluster. I called mine "),s("code",[t._v("madadmin")]),t._v(" and selected the "),s("code",[t._v("autogenerate password")]),t._v(" option for a reasonably secure random password.")]),t._v(" "),s("p",[s("img",{attrs:{src:e(322),alt:"create database user"}})]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("Copy the password")]),t._v(" "),s("p",[t._v("Don't forget to click the "),s("code",[t._v("show")]),t._v(" button next to the password, and then copy it to your config JSON file. You will never see this password again.")])]),t._v(" "),s("p",[t._v("We need to get the connection string details for this new database cluster. Click the "),s("code",[t._v("Choose connection method")]),t._v(" button at the bottom of the modal.\n"),s("img",{attrs:{src:e(323),alt:"create database user"}})]),t._v(" "),s("p",[t._v("We want the middle option "),s("strong",[t._v("Connect your application")]),t._v(".\n"),s("img",{attrs:{src:e(256),alt:"cluster connection options"}})]),t._v(" "),s("p",[t._v("Copy the "),s("strong",[t._v("hostname")]),t._v(" portion of the connection string. We will need that in our config JSON file.\n"),s("img",{attrs:{src:e(324),alt:"cluster connection string"}})]),t._v(" "),s("p",[t._v("Copy the "),s("strong",[t._v("authentication database name")]),t._v(" portion of the connection string. We will need that in our config JSON file too.\n"),s("img",{attrs:{src:e(325),alt:"cluster connection string"}})]),t._v(" "),s("h3",{attrs:{id:"connect-mongoose-to-the-atlas-cluster"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#connect-mongoose-to-the-atlas-cluster"}},[t._v("#")]),t._v(" Connect Mongoose to the Atlas Cluster")]),t._v(" "),s("p",[t._v("Up until now, the connection string to tell Mongoose how to open a connection to the database took this format:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("mongodb://hostname:port/database-name\n")])])]),s("p",[t._v("e.g.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("mongodb://localhost:27017/mad9124\n")])])]),s("h4",{attrs:{id:"hosted-atlas-cluster"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hosted-atlas-cluster"}},[t._v("#")]),t._v(" Hosted Atlas Cluster")]),t._v(" "),s("p",[t._v("The full connection string for MongoDB databases hosted on an Atlas cluster look a little different. Here is what mine looks like:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("mongodb+srv://<username>:<password>@giftr-1p8fa.mongodb.net/test?retryWrites=true&w=majority\n")])])]),s("p",[s("em",[t._v("(Don't use this one. Go get your own.)")])]),t._v(" "),s("h5",{attrs:{id:"from-the-above-examples"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#from-the-above-examples"}},[t._v("#")]),t._v(" From the above examples")]),t._v(" "),s("p",[t._v("The scheme changes to "),s("code",[t._v("mongodb+srv://")])]),t._v(" "),s("p",[t._v("Database user credentials are inserted: "),s("code",[t._v("<username>:<password>@")])]),t._v(" "),s("p",[t._v("The hostname becomes "),s("code",[t._v("_something_.mongodb.net")])]),t._v(" "),s("p",[t._v("The default database "),s("code",[t._v("/test")]),t._v(" is used to authenticate the db user.")]),t._v(" "),s("p",[t._v("There are some other options set at the end: "),s("code",[t._v("?retryWrites=true&w=majority")])]),t._v(" "),s("h3",{attrs:{id:"update-the-connectdatabase-js-module"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#update-the-connectdatabase-js-module"}},[t._v("#")]),t._v(" Update the "),s("code",[t._v("connectDatabase.js")]),t._v(" Module")]),t._v(" "),s("p",[t._v("It is a very common practice to set up a final integration testing or staging environment that very closely mirrors the production environment. That is what we are going to do for the final project. This will allow us to simplify some of the deployment details.")]),t._v(" "),s("p",[t._v("Remember we are retrieving the configuration variables using the "),s("code",[t._v("config.get()")]),t._v(" method. We will set the "),s("code",[t._v("NODE_ENV")]),t._v(" environment variable to"),s("code",[t._v("stage")]),t._v(", so you will need to create a new "),s("code",[t._v("/config/stage.json")]),t._v(" file with your connection credentials. e.g.")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"db"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scheme"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mongodb+srv"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"madadmin"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"password"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"yourGuessIsAsGoodAsMine"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"host"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"giftr-1p8fa.mongodb.net"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"authSource"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"w20-final-giftr"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v("In a final production deployment, you would not store the database username and password in this config file. They should be injected into the runtime container using environment variables.")]),t._v(" "),s("p",[t._v("But, this will let us better help you with troubleshooting and help us with grading your assignment.")])]),t._v(" "),s("p",[t._v("Then in the "),s("code",[t._v("/startup/connectDatabase.js")]),t._v(" module, we need to conditionally construct the connection string based on the target scheme: "),s("code",[t._v("mongodb")]),t._v(" v.s. "),s("code",[t._v("mongodb+srv")]),t._v(".")]),t._v(" "),s("p",[t._v("The updated file should look something like this ...")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'config'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./logger'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" mongoose "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongoose'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmodule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("exports")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("scheme"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" host"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" authSource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'db'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" credentials "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" username "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" password "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("password"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("@")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" connectionString "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("scheme"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("://")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("credentials"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("host"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("scheme "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mongodb'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    connectionString "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("?authSource=")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("authSource"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    connectionString "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("/")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("authSource"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("?retryWrites=true&w=majority")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  mongoose\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("connect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      connectionString"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useNewUrlParser")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useUnifiedTopology")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useCreateIndex")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("useFindAndModify")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("dbName")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" name\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'info'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Connected to MongoDB @ ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Error connecting to MongoDB ...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("OK. LET'S TEST IT!")])]),t._v(" "),s("p",[t._v("Update the "),s("code",[t._v("scripts")]),t._v(" key of the "),s("code",[t._v("package.json")]),t._v(" file to add a "),s("code",[t._v("stage")]),t._v(" script that is the same as the "),s("code",[t._v("dev")]),t._v(" script except that we will set "),s("code",[t._v("NODE_ENV=stage")]),t._v(".")]),t._v(" "),s("div",{staticClass:"language-json extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"scripts"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"test"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"echo \\"Error: no test specified\\" && exit 1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"dev"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"API_JWTKEY=supersecretkey nodemon server.js"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"stage"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NODE_ENV=stage API_JWTKEY=supersecretkey nodemon server.js"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"start"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node server.js"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),s("p",[t._v("Now run "),s("code",[t._v("npm run stage")]),t._v(" in the terminal and use Postman to make sure that everything is working.")]),t._v(" "),s("p",[t._v("You can still visually check the contents of the database with MongoDB Compass. Just use full the connection string from the Atlas dashboard.")]),t._v(" "),s("p",[s("img",{attrs:{src:e(256),alt:"cluster connection options"}})]),t._v(" "),s("p",[t._v("Don't forget to replace "),s("code",[t._v("<password>")]),t._v(" with your real password. e.g.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("mongodb+srv://madadmin:yourGuessIsAsGoodAsMine@giftr-1p8fa.mongodb.net/test\n")])])]),s("h2",{attrs:{id:"health-check-route"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#health-check-route"}},[t._v("#")]),t._v(" Health Check Route")]),t._v(" "),s("p",[t._v("Most production deployments will have some kind of automated periodic monitoring to see if your deployed service is still up and running. We will facilitate this by creating a simple HTTP route handler in the main "),s("code",[t._v("app.js")]),t._v(" module. It could be anything that we choose. The AWS HTTP Load Balancer will default to the root path for our service, so let's just use that for now.")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("healthStatus")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'UP'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("The AWS container management service will regularly poll this route looking for a "),s("code",[t._v("200")]),t._v(" response code. You will be able to see the health status in the AWS CloudWatch console.")]),t._v(" "),s("h2",{attrs:{id:"publish-a-docker-image"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#publish-a-docker-image"}},[t._v("#")]),t._v(" Publish a Docker Image")]),t._v(" "),s("p",[t._v("In most development teams these days, everyone needs to know a little about DevOps. You could do a whole course on Docker, containers, and Kubernetes, but for now we are going to simulate a scenario that you are very like to encounter. As a junior developer, a more senior developer on the team has already worked out the correct procedure to bundle and deploy your application, and they will give you some key files and instructions.")]),t._v(" "),s("p",[t._v("Starting in module 5, you have been using Docker as an easy way to run MongoDB in your local development environment. We used a pre-made Docker Image definition (mongo:bionic) that we pulled from the Docker Hub repository.")]),t._v(" "),s("p",[t._v("You can create and publish our own Docker Image to bundle your Express web service application. This image can then be use to deploy one or more copies of your application on a cloud hosting service like AWS, Azure, or Google Cloud.")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("If you haven't already ...")]),t._v(" "),s("p",[t._v("Create a free "),s("a",{attrs:{href:"https://hub.docker.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker Hub"),s("OutboundLink")],1),t._v(" account."),s("br"),t._v("\nDownload "),s("strong",[t._v("Docker Desktop")]),t._v(" and run the installer.")])]),t._v(" "),s("h3",{attrs:{id:"create-a-dockerfile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-a-dockerfile"}},[t._v("#")]),t._v(" Create a Dockerfile")]),t._v(" "),s("p",[t._v("The "),s("code",[t._v("Dockerfile")]),t._v(" is the recipe for creating a Docker Image. It should be placed in the top level of your project folders. Note the capitalization and there is no extension - just "),s("code",[t._v("Dockerfile")]),t._v(".")]),t._v(" "),s("p",[t._v("This will use the "),s("a",{attrs:{href:"https://hub.docker.com/_/node",target:"_blank",rel:"noopener noreferrer"}},[t._v("official node version 12 image"),s("OutboundLink")],1),t._v(" from Docker Hub as the starting point. It then creates the directory structure that our project requires and copies your code from the local project folder into the container image.")]),t._v(" "),s("p",[s("strong",[t._v("Make sure that your project folder structure matches the Dockerfile.")])]),t._v(" "),s("div",{staticClass:"language-docker extra-class"},[s("pre",{pre:!0,attrs:{class:"language-docker"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node:12-slim")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" API_PORT="),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"80"')])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" DEBUG="),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"api:*"')])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" mkdir -p /app /app/config /app/exceptions /app/logs /app/middleware /app/models /app/public /app/routes /app/startup")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" config/ /app/config/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" exceptions/ /app/exceptions/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" middleware/ /app/middleware/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" models/ /app/models/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" public/ /app/public/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" routes/ /app/routes/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" startup/ /app/startup/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" server.js app.js package.json /app/")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install --unsafe-perm")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 80")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" node server.js")]),t._v("\n")])])]),s("h3",{attrs:{id:"split-server-js-and-app-js"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#split-server-js-and-app-js"}},[t._v("#")]),t._v(" Split server.js and app.js")]),t._v(" "),s("p",[t._v("That final line in the Dockerfile, "),s("code",[t._v("CMD node server.js")]),t._v(". That is the command that will be invoked when the deployed container is started. If you have all of your Express application defined in "),s("code",[t._v("app.js")]),t._v(", then you could change the last line of the Dockerfile to be "),s("code",[t._v("CMD node app.js")]),t._v(".")]),t._v(" "),s("p",[t._v("Or, you might want to create both a "),s("code",[t._v("server.js")]),t._v(" file and an "),s("code",[t._v("app.js")]),t._v(" file. This is a quite common practice as it separates the code for defining middleware and route handlers in the "),s("code",[t._v("app.js")]),t._v(" file which is then imported into the "),s("code",[t._v("server.js")]),t._v(" module which then only holds the instructions spinning up the Node.js HTTP server, passing in the "),s("code",[t._v("app.js")]),t._v(" module as a configuration object to the server (see lines 5 and 11 in the code example below).")]),t._v(" "),s("p",[t._v("Here is an example "),s("code",[t._v("server.js")]),t._v(" file serving only HTTP."),s("br"),t._v(" "),s("strong",[t._v("This is what you should use for your final project.")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'use strict'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" http "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./startup/logger'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Create HTTP server.\n * HTTP server listen on provided port, on all network interfaces.\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" server "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" port "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("API_PORT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3030")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listening'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onListening"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Common listener callback functions\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Express failed to listen on port ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" ...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onListening")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'info'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Express is listening on port ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" ...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("If you are going to be running your Node.js server with HTTPS, you "),s("strong",[t._v("must")]),t._v(" set it up this way.")])]),t._v(" "),s("p",[t._v('Here is how it would look if we set it up to use HTTPS with a "let\'s encrypt" certificate.'),s("br"),t._v(" "),s("strong",[t._v("This is for your future reference only. DO NOT use this for your final project.")])]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'use strict'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" http "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" https "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" logger "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./startup/logger'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Create HTTP server.\n * HTTP server listen on provided port, on all network interfaces.\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" server "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" http"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" port "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("API_PORT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3030")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listening'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onListening"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Create HTTPS server.\n * HTTPS server listen on standard port, on all network interfaces.\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" options "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/etc/letsencrypt/live/mad9124.rocks/privkey.pem'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("cert")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/etc/letsencrypt/live/mad9124.rocks/fullchain.pem'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("ca")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" fs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFileSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/etc/letsencrypt/live/mad9124.rocks/chain.pem'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" serverSSL "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" TLSPort "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("APP_TLSPORT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\n  serverSSL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TLSPort"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  serverSSL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  serverSSL"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'listening'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onListening"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/**\n * Common listener callback functions\n */")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onError")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("err")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'error'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Express failed to listen on port ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" ...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("onListening")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  logger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'info'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token template-string"}},[s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("Express is listening on port ")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port"),s("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" ...")]),s("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"simplified-app-js"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#simplified-app-js"}},[t._v("#")]),t._v(" Simplified app.js")]),t._v(" "),s("p",[t._v("Now that the "),s("code",[t._v("app.js")]),t._v(" module doesn't need any code for creating the HTTP server, it can be simplified to something like this ...")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./startup/connectDatabase'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" express "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("express")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Apply global middleware with app.use()")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Add the health check route")]),t._v("\napp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("healthStatus")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'UP'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Link the auth and api route handler modules")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Apply the global error handler middleware")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Export the `app` object")]),t._v("\nmodule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" app\n")])])]),s("h3",{attrs:{id:"build-a-local-docker-image"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#build-a-local-docker-image"}},[t._v("#")]),t._v(" Build a local Docker image")]),t._v(" "),s("p",[t._v("We have created the Dockerfile and refactored our code. It is time to build the container image with the "),s("a",{attrs:{href:"https://docs.docker.com/engine/reference/commandline/build/",target:"_blank",rel:"noopener noreferrer"}},[t._v("docker build"),s("OutboundLink")],1),t._v(" command. Use the "),s("code",[t._v("--tag=")]),t._v(" command option to set the name of the local Docker Image file that will be created. The "),s("code",[t._v(":latest")]),t._v(" suffix is the version label.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker build --tag=giftr-api-w20:latest .\n")])])]),s("p",[t._v("This will create an Ubuntu Linux container with Node v12 pre configured and then copy in your project files as defined in the "),s("code",[t._v("Dockerfile")]),t._v(". Then it will run "),s("code",[t._v("npm install")]),t._v(" in your project root folder (in the container) to ensure that all required dependencies are correctly installed.")]),t._v(" "),s("p",[t._v("When this process is complete you will have a new Docker Image that you can use to create a complete isolated runtime of your Express web service application. You can run it locally to test it.")]),t._v(" "),s("p",[t._v("Here is an updated "),s("code",[t._v("docker-compose.yml")]),t._v(" file that will spin up your new container on your local machine for testing. First, make sure that you stop any other Express server that you might have running.")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3.1'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mongo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("bionic\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mongo\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_ROOT_USERNAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" madadmin\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("MONGO_INITDB_ROOT_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" supersecretpassword\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 27017"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("27017")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ./data/mongo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/data/db\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("express")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" giftr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w20\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" giftr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("w20\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("depends_on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mongo\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("API_JWTKEY")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" keur0uhwg802fkzh6e72lw0m69g3xv\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("API_PORT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("NODE_ENV")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'stage'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 3030"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node server.js\n")])])]),s("p",[t._v("Now run "),s("code",[t._v("docker-compose up -d")]),t._v(". If everything is configured correctly, your new API server container will spin up and try to authenticate with the MongoDB Atlas server that you setup earlier.")]),t._v(" "),s("p",[t._v("Try sending some test requests from Postman to "),s("code",[t._v("localhost:3030")]),t._v(". Then check the MongoDB Atlas database with MongoDB Compass to visually verify the requests went to the correct database.")]),t._v(" "),s("p",[t._v("If everything looks good we can publish the Docker Image on Docker Hub.")]),t._v(" "),s("h3",{attrs:{id:"tag-the-image"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tag-the-image"}},[t._v("#")]),t._v(" Tag the image")]),t._v(" "),s("p",[t._v("Before you can push the image up to Docker Hub, you need to "),s("code",[t._v("tag")]),t._v(" the local image with your Docker Hub username prefix. Replace "),s("code",[t._v("<username>")]),t._v(" with your Docker Hub username.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker tag giftr-api-w20 <username>/giftr-api-w20\n")])])]),s("h3",{attrs:{id:"push-the-image-to-docker-hub"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#push-the-image-to-docker-hub"}},[t._v("#")]),t._v(" Push the image to Docker Hub")]),t._v(" "),s("p",[t._v("Make sure that you are logged into Docker Hub. This command will prompt you for your Docker Hub username and password.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker login docker.io\n")])])]),s("p",[t._v("Now you can push it. Replace "),s("code",[t._v("<username>")]),t._v(" with your Docker Hub username.")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker push <username>/giftr-api-w20\n")])])]),s("p",[s("strong",[t._v("Congratulations!")])]),t._v(" "),s("p",[t._v("You have successfully published your first Docker Image.")]),t._v(" "),s("h2",{attrs:{id:"deploying-to-aws"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploying-to-aws"}},[t._v("#")]),t._v(" Deploying to AWS")]),t._v(" "),s("p",[t._v("Now it is time to setup the hosting environment on AWS for your Docker container to run.")]),t._v(" "),s("h3",{attrs:{id:"aws-classroom-account"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aws-classroom-account"}},[t._v("#")]),t._v(" AWS Classroom Account")]),t._v(" "),s("p",[t._v("By now you should have received an email invitation to join our AWS Classroom and sign-up for a free AWS Educate - Student Account. There are "),s("a",{attrs:{href:"https://aws.amazon.com/education/awseducate/students/",target:"_blank",rel:"noopener noreferrer"}},[t._v("many benefits"),s("OutboundLink")],1),t._v(" attached to the free student account which you can use to continue your learning over the summer.")]),t._v(" "),s("p",[t._v('Once you have accepted the invitation and logged into the AWS Educate portal, find the link to "My Classrooms". You should see one listed for "Mobile API Development". Click the blue "Go to classroom" button on the right.\n'),s("img",{attrs:{src:e(326),alt:"AWS classrooms list"}})]),t._v(" "),s("p",[t._v("You will now be prompted to agree to the "),s("em",[t._v("terms and conditions")]),t._v(" for using the service.\n"),s("img",{attrs:{src:e(239),alt:"Vocareum dashboard"}})]),t._v(" "),s("p",[t._v("Your browser should be redirected to the "),s("strong",[t._v("Vocareum Dashboard")]),t._v(". Click on the card for Mobile API Development. This will open a summary page for your AWS Educate Classroom Account. It has some helpful FAQs and you can see your remaining credit balance for AWS services. You have been given a $50 for this classroom, which is more than enough to cover what we will do, and give you some credits to play with over the summer.\n"),s("img",{attrs:{src:e(240),alt:"AWS account summary"}})]),t._v(" "),s("p",[t._v("Click on the "),s("strong",[t._v("AWS Console")]),t._v(" button and you will be automatically logged into the AWS Console with your AWS Educate Classroom account.")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),s("p",[t._v('This may trigger the "pop-up blocker" in your browser. You will need to grant permission for this site. Look for the warning notice in the URL bar.')])]),t._v(" "),s("p",[t._v("Now you know how to get logged in. We can start doing real work!\n"),s("img",{attrs:{src:e(241),alt:"AWS console"}})]),t._v(" "),s("h3",{attrs:{id:"configure-the-elastic-container-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-the-elastic-container-service"}},[t._v("#")]),t._v(" Configure the Elastic Container Service")]),t._v(" "),s("h4",{attrs:{id:"_1-go-to-the-ecs-console"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-go-to-the-ecs-console"}},[t._v("#")]),t._v(" 1. Go to the ECS console")]),t._v(" "),s("p",[t._v("Type "),s("code",[t._v("ECS")]),t._v(" into the "),s("strong",[t._v("Find Services")]),t._v(" search box on the AWS Console and then select the "),s("strong",[t._v("Elastic Container Service")]),t._v(" "),s("img",{attrs:{src:e(327),alt:"AWS console - search"}})]),t._v(" "),s("h4",{attrs:{id:"_2-start-the-setup-wizard"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-start-the-setup-wizard"}},[t._v("#")]),t._v(" 2. Start the Setup Wizard")]),t._v(" "),s("p",[t._v("On the next screen you should see a "),s("strong",[t._v("Get Started")]),t._v(' button. Click that to start the "First Run Wizard". This is a more automated path to provision your container service cluster.\n'),s("img",{attrs:{src:e(328),alt:"ECS console - get started"}})]),t._v(" "),s("h4",{attrs:{id:"_3-define-aws-ecs-container-task-service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-define-aws-ecs-container-task-service"}},[t._v("#")]),t._v(" 3. Define AWS ECS Container/Task/Service")]),t._v(" "),s("p",[t._v("Now define the runtime parameters for your container service. There are several related parts and they fit together like Russian nesting dolls.")]),t._v(" "),s("ul",[s("li",[t._v("A container definition links to a Docker image.")]),t._v(" "),s("li",[t._v("A task sets the resources for a container definition.")]),t._v(" "),s("li",[t._v("A service may include one or more related tasks.")]),t._v(" "),s("li",[t._v("A cluster may host one or more services.")])]),t._v(" "),s("p",[s("img",{attrs:{src:e(329),alt:"ECS hierarchy diagram"}})]),t._v(" "),s("p",[t._v("Start with the inner most box and work out.")]),t._v(" "),s("h5",{attrs:{id:"container-definition"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#container-definition"}},[t._v("#")]),t._v(" Container Definition")]),t._v(" "),s("p",[t._v("Choose the "),s("strong",[t._v("custom")]),t._v(" configuration card and click the "),s("strong",[t._v("configure")]),t._v(" button.\n"),s("img",{attrs:{src:e(330),alt:"ECS wizard step 1"}})]),t._v(" "),s("p",[t._v("Set these settings in the "),s("strong",[t._v("Standard")]),t._v(" section of the configuration form:")]),t._v(" "),s("ul",[s("li",[t._v("Container name: "),s("code",[t._v("giftr-api-container")])]),t._v(" "),s("li",[t._v("Image: "),s("code",[t._v("<Docker-Hub-username>/giftr-api-w20")])]),t._v(" "),s("li",[t._v("Soft limit: "),s("code",[t._v("500")])]),t._v(" "),s("li",[t._v("Port mapping: "),s("code",[t._v("80")])])]),t._v(" "),s("p",[s("img",{attrs:{src:e(331),alt:"ECS wizard step 2"}})]),t._v(" "),s("p",[t._v("Expand the "),s("strong",[t._v("Advanced container configuration")]),t._v(" section of the form and scroll down to the "),s("strong",[t._v("Environment Variables")]),t._v(" heading. Add the following key:value pairs:")]),t._v(" "),s("ul",[s("li",[t._v("NODE_ENV = "),s("code",[t._v("stage")])]),t._v(" "),s("li",[t._v("API_PORT = "),s("code",[t._v("80")])]),t._v(" "),s("li",[t._v("API_JWTKEY = "),s("code",[t._v("<your-secret-random-key>")])])]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),s("p",[t._v("Use the "),s("code",[t._v("genKey.js")]),t._v(" script from week 11 to generate a new random key.")])]),t._v(" "),s("p",[s("img",{attrs:{src:e(332),alt:"ECS wizard step 3"}})]),t._v(" "),s("p",[t._v("Then scroll all the way to the bottom and check the "),s("strong",[t._v("Auto-configure CloudWatch Logs")]),t._v(" option next to "),s("strong",[t._v("Log Configuration")]),t._v(". Then click the blue "),s("strong",[t._v("Update")]),t._v(" button in the bottom right corner.\n"),s("img",{attrs:{src:e(333),alt:"ECS wizard step 4"}})]),t._v(" "),s("h5",{attrs:{id:"task-definition"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#task-definition"}},[t._v("#")]),t._v(" Task Definition")]),t._v(" "),s("p",[t._v("The slide over dialog will close and you will be back to the main ECS Configuration Wizard. Scroll down and click the "),s("strong",[t._v("Edit")]),t._v(" button on the "),s("strong",[t._v("Task Definition")]),t._v(" line. Change the task definition name to "),s("code",[t._v("giftr-api-task")]),t._v(" and click the "),s("strong",[t._v("Save")]),t._v(" button.\n"),s("img",{attrs:{src:e(334),alt:"ECS wizard step 5"}})]),t._v(" "),s("p",[t._v("Now click the "),s("strong",[t._v("Next")]),t._v(" button in the bottom right corner.\n"),s("img",{attrs:{src:e(335),alt:"ECS wizard step 6"}})]),t._v(" "),s("h5",{attrs:{id:"service-definition"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-definition"}},[t._v("#")]),t._v(" Service Definition")]),t._v(" "),s("p",[t._v("The service defaults to no load balancer. Change the selection in the middle of the page to "),s("strong",[t._v("Application Load Balancer")]),t._v(". This will set it for port 80 HTTP.\n"),s("img",{attrs:{src:e(336),alt:"ECS wizard step 7"}})]),t._v(" "),s("p",[t._v("Next click the "),s("strong",[t._v("Edit")]),t._v(" button on the "),s("strong",[t._v("Define your service")]),t._v(" line. Set the "),s("strong",[t._v("number of desired tasks")]),t._v(" to be "),s("code",[t._v("2")]),t._v(" and then click the blue "),s("strong",[t._v("Save")]),t._v(" button.\n"),s("img",{attrs:{src:e(337),alt:"ECS wizard step 8"}})]),t._v(" "),s("p",[t._v("The main ECS configuration wizard screen should now look like this screenshot. Click the blue "),s("strong",[t._v("Next")]),t._v(" button.\n"),s("img",{attrs:{src:e(338),alt:"ECS wizard step 9"}})]),t._v(" "),s("h5",{attrs:{id:"cluster-definition"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cluster-definition"}},[t._v("#")]),t._v(" Cluster Definition")]),t._v(" "),s("p",[t._v("Set the cluster name to "),s("code",[t._v("mad9124")]),t._v(", and click the blue "),s("strong",[t._v("Next")]),t._v(" button.\n"),s("img",{attrs:{src:e(339),alt:"ECS wizard step 10"}})]),t._v(" "),s("p",[t._v("Take one last look at all of the settings on the "),s("strong",[t._v("Review")]),t._v(" page.\n"),s("img",{attrs:{src:e(340),alt:"ECS wizard step 11"}})]),t._v(" "),s("p",[t._v("Then click the blue "),s("strong",[t._v("Create")]),t._v(" button, and watch the progress spinners for 5 to 10 minutes.\n"),s("img",{attrs:{src:e(341),alt:"ECS wizard step 12"}})]),t._v(" "),s("p",[s("strong",[t._v("WOOO HOOOO! You have launched your first AWS CloudFormation Stack!")])]),t._v(" "),s("p",[t._v("When all 10 provisioning steps have a green check mark, you can click the "),s("strong",[t._v("View Service")]),t._v(" button to go back to the ECS Dashboard. This will take to detail view for your newly provisioned service. It should look something like this ...\n"),s("img",{attrs:{src:e(342),alt:"ECS service details"}})]),t._v(" "),s("h4",{attrs:{id:"_4-test-with-load-balancer-address-with-postman"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-test-with-load-balancer-address-with-postman"}},[t._v("#")]),t._v(" 4. Test with Load Balancer address with Postman")]),t._v(" "),s("p",[t._v("So, now we should run some Postman test. But what is the URL?")]),t._v(" "),s("p",[t._v('In the ECS service definition, we created an application load balancer. This will be the "front door" URL for your API service cluster.')]),t._v(" "),s("p",[t._v("To find the load balancer's public DNS name, we need to go to the EC2 Console section of AWS.")]),t._v(" "),s("p",[t._v("Click on the "),s("strong",[t._v("Services")]),t._v(" top menu drop-down and then select "),s("strong",[t._v("EC2")]),t._v(" from the top of the "),s("em",[t._v("Compute")]),t._v(" service list.\n"),s("img",{attrs:{src:e(343),alt:"Navigate to EC2"}})]),t._v(" "),s("p",[t._v("This will take you to the main EC2 Dashboard. Select "),s("strong",[t._v("Load Balancers")]),t._v(" from the Resource options in the middle of the page.\n"),s("img",{attrs:{src:e(344),alt:"EC2 dashboard"}})]),t._v(" "),s("p",[t._v("You will now see the list of active load balancers on your AWS Classroom account. There should only be one at this point. Click the check box next to the name of your load balancer to see the details at the bottom of the screen.\n"),s("img",{attrs:{src:e(345),alt:"EC2 load balancer details"}})]),t._v(" "),s("p",[t._v("Copy the "),s("strong",[t._v("DNS name")]),t._v(" and use that as the hostname for your Postman tests.")]),t._v(" "),s("h4",{attrs:{id:"_5-link-to-load-balancer-in-client-app"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-link-to-load-balancer-in-client-app"}},[t._v("#")]),t._v(" 5. Link to Load Balancer in client app.")]),t._v(" "),s("p",[t._v("In a real app, you could now use this URL in the "),s("code",[t._v("fetch")]),t._v(" code of your frontend client application.")]),t._v(" "),s("p",[t._v('You would also want to turn on HTTPS for the load balancer, or your browser will block access to "mixed content requests". At the moment, the AWS Classroom accounts don\'t have access to the AWS Certificate Manager Service, so we cannot do this right now.')]),t._v(" "),s("h3",{attrs:{id:"congratulations"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#congratulations"}},[t._v("#")]),t._v(" Congratulations!")]),t._v(" "),s("p",[t._v("You have successfully deployed a load balanced redundant API web service container cluster connected to a separate redundant database cluster — all hosted on Amazon Web Services.")]),t._v(" "),s("h2",{attrs:{id:"for-additional-resources"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#for-additional-resources"}},[t._v("#")]),t._v(" For additional resources")]),t._v(" "),s("p",[t._v("The procedure above is an excellent introduction to containers and AWS. This can be a great talking point in a job interview, but there is more to learn. Please review these additional online resources.")]),t._v(" "),s("ul",[s("li",[s("p",[s("a",{attrs:{href:"https://aws.amazon.com/ecs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Amazon Elastic Container Service"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://aws.amazon.com/fargate",target:"_blank",rel:"noopener noreferrer"}},[t._v("AWS Fargate"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://aws.amazon.com/vpc/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Amazon Virtual Private Cloud"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://aws.amazon.com/elasticloadbalancing",target:"_blank",rel:"noopener noreferrer"}},[t._v("Amazon Elastic Load Balancing"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://docs.docker.com/engine/docker-overview/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker overview"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://www.youtube.com/watch?v=YFl2mCHdv24",target:"_blank",rel:"noopener noreferrer"}},[t._v("Learn Docker in 12 Minutes"),s("OutboundLink")],1)])]),t._v(" "),s("li",[s("p",[s("a",{attrs:{href:"https://www.youtube.com/watch?v=Qw9zlE3t8Ko",target:"_blank",rel:"noopener noreferrer"}},[t._v("Docker Compose in 12 Minutes"),s("OutboundLink")],1)])])])],1)}),[],!1,null,null,null);s.default=n.exports}}]);